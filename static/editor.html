<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudySnap HTML Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
        }

        .editor-header {
            background: white;
            border-bottom: 1px solid #ddd;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .editor-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .editor-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #E11D48;
            color: white;
        }

        .btn-primary:hover {
            background: #BE123C;
        }

        .btn-secondary {
            background: #6B7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4B5563;
        }

        .btn-success {
            background: #10B981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .editor-container {
            display: flex;
            height: calc(100vh - 70px);
        }

        .file-list {
            width: 200px;
            min-width: 150px;
            background: white;
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }

        .file-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .file-item:hover {
            background: #f9fafb;
        }

        .file-item.active {
            background: #E11D4820;
            border-left: 3px solid #E11D48;
        }

        .file-name {
            font-size: 0.85em;
            color: #333;
            margin-bottom: 3px;
            word-break: break-all;
        }

        .file-time {
            font-size: 0.7em;
            color: #888;
        }

        /* ì¢Œìš° ë¶„í•  ë ˆì´ì•„ì›ƒ */
        .split-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .editor-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-right: 1px solid #ddd;
            min-width: 300px;
        }

        .preview-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f9fafb;
            min-width: 300px;
        }

        .panel-header {
            padding: 10px 15px;
            background: #f3f4f6;
            border-bottom: 1px solid #ddd;
            font-weight: 600;
            font-size: 0.9em;
            color: #374151;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header .panel-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ë¦¬ì‚¬ì´ì € */
        .resizer {
            width: 6px;
            background: #e5e7eb;
            cursor: col-resize;
            transition: background 0.2s;
        }

        .resizer:hover {
            background: #E11D48;
        }

        .toolbar {
            padding: 8px 10px;
            background: #f9fafb;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            padding: 5px 10px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .toolbar-btn:hover {
            background: #f3f4f6;
        }

        .editor-content {
            flex: 1;
            overflow: hidden;
            padding: 10px;
        }

        #htmlEditor {
            width: 100%;
            height: 100%;
            border: 1px solid #ddd;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            resize: none;
            background: #fefefe;
        }

        .preview-content {
            flex: 1;
            overflow: hidden;
            background: white;
            margin: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .preview-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        .status-bar {
            padding: 6px 15px;
            background: #f9fafb;
            border-top: 1px solid #ddd;
            font-size: 0.8em;
            color: #666;
            display: flex;
            justify-content: space-between;
        }

        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 12px 20px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            z-index: 2000;
        }

        .notification.show {
            display: block;
            animation: slideIn 0.3s;
        }

        .notification.success {
            border-left: 4px solid #10B981;
        }

        .notification.error {
            border-left: 4px solid #EF4444;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ë™ê¸°í™” í‘œì‹œ */
        .sync-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75em;
            color: #10B981;
        }

        .sync-indicator.syncing {
            color: #F59E0B;
        }

        /* ëª¨ë°”ì¼ í”„ë¦¬ë·° ì˜µì…˜ */
        .preview-size-btn {
            padding: 4px 8px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.75em;
        }

        .preview-size-btn.active {
            background: #E11D48;
            color: white;
            border-color: #E11D48;
        }

        .preview-sizes {
            display: flex;
            gap: 5px;
        }

        /* ë¯¸ë¦¬ë³´ê¸° í¬ê¸° ì¡°ì ˆ */
        .preview-wrapper {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow: auto;
            padding: 10px;
            background: #e5e7eb;
        }

        .preview-device {
            background: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            overflow: hidden;
            transition: all 0.3s;
        }

        .preview-device.desktop {
            width: 100%;
            height: 100%;
        }

        .preview-device.tablet {
            width: 768px;
            height: 100%;
            border-radius: 8px;
        }

        .preview-device.mobile {
            width: 375px;
            height: 100%;
            border-radius: 20px;
            border: 8px solid #333;
        }

        /* ì—ë””í„°-ë¯¸ë¦¬ë³´ê¸° ì—°ë™ í•˜ì´ë¼ì´íŠ¸ */
        .editor-highlight {
            background: linear-gradient(90deg, #FBBF24 0%, #FDE68A 100%);
            border-radius: 2px;
        }

        #htmlEditor.line-highlight {
            background-image: linear-gradient(
                transparent 0,
                transparent calc(var(--highlight-line) * 1.5em - 0.75em),
                rgba(251, 191, 36, 0.3) calc(var(--highlight-line) * 1.5em - 0.75em),
                rgba(251, 191, 36, 0.3) calc(var(--highlight-line) * 1.5em + 0.75em),
                transparent calc(var(--highlight-line) * 1.5em + 0.75em)
            );
        }

        /* ì—°ë™ ëª¨ë“œ í‘œì‹œ */
        .sync-mode-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 8px;
            background: #FEF3C7;
            border: 1px solid #F59E0B;
            border-radius: 4px;
            font-size: 0.7em;
            color: #92400E;
            margin-left: 10px;
        }

        .sync-mode-indicator.active {
            background: #D1FAE5;
            border-color: #10B981;
            color: #065F46;
        }

        /* í•˜ì´ë¼ì´íŠ¸ íˆ´íŒ */
        .highlight-tooltip {
            position: fixed;
            background: #1F2937;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            z-index: 9999;
            pointer-events: none;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .highlight-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1F2937 transparent transparent transparent;
        }
    </style>
</head>
<body>
    <div class="editor-header">
        <div class="editor-title">ğŸ“ StudySnap HTML Editor</div>
        <div class="editor-controls">
            <button class="btn btn-secondary" onclick="swapPanels()" title="í¸ì§‘/ë¯¸ë¦¬ë³´ê¸° ìœ„ì¹˜ ë°”ê¾¸ê¸°">â†”ï¸ ì¢Œìš°ì „í™˜</button>
            <button class="btn btn-secondary" onclick="toggleSyncMode()" id="syncModeBtn" title="ë§ˆìš°ìŠ¤ ìœ„ì¹˜ì— ë”°ë¼ í¸ì§‘ê¸°â†”ë¯¸ë¦¬ë³´ê¸° ì—°ë™ í•˜ì´ë¼ì´íŠ¸">ğŸ”— ì—°ë™ëª¨ë“œ</button>
            <button class="btn btn-secondary" onclick="loadFiles()">ìƒˆë¡œê³ ì¹¨</button>
            <button class="btn btn-success" onclick="saveFile()">ğŸ’¾ ì €ì¥</button>
            <button class="btn btn-primary" onclick="downloadFile()">â¬‡ï¸ ë‹¤ìš´ë¡œë“œ</button>
        </div>
    </div>

    <div class="editor-container">
        <div class="file-list" id="fileList">
            <div style="padding: 15px; text-align: center; color: #888;">
                íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
        </div>

        <!-- ì¢Œìš° ë¶„í•  ì»¨í…Œì´ë„ˆ -->
        <div class="split-container" id="splitContainer">
            <!-- í¸ì§‘ íŒ¨ë„ (ì™¼ìª½) -->
            <div class="editor-panel" id="editorPanel">
                <div class="panel-header">
                    <div class="panel-title">
                        âœï¸ í¸ì§‘
                    </div>
                    <span class="sync-indicator" id="syncIndicator">â— ë™ê¸°í™”ë¨</span>
                </div>
                <div class="toolbar">
                    <button class="toolbar-btn" onclick="formatText('bold')"><b>B</b></button>
                    <button class="toolbar-btn" onclick="formatText('italic')"><i>I</i></button>
                    <button class="toolbar-btn" onclick="formatText('underline')"><u>U</u></button>
                    <span style="border-left: 1px solid #ddd; margin: 0 5px;"></span>
                    <button class="toolbar-btn" onclick="insertElement('h1')">ì œëª©1</button>
                    <button class="toolbar-btn" onclick="insertElement('h2')">ì œëª©2</button>
                    <button class="toolbar-btn" onclick="insertElement('p')">ë³¸ë¬¸</button>
                    <span style="border-left: 1px solid #ddd; margin: 0 5px;"></span>
                    <button class="toolbar-btn" onclick="beautifyHTML()">ì½”ë“œ ì •ë¦¬</button>
                    <button class="toolbar-btn" onclick="findReplace()">ì°¾ê¸°/ë°”ê¾¸ê¸°</button>
                </div>
                <div class="editor-content">
                    <textarea id="htmlEditor" placeholder="HTML íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”..."></textarea>
                </div>
                <div class="status-bar">
                    <span id="statusText">íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</span>
                    <span id="charCount">0 ì</span>
                </div>
            </div>

            <!-- ë¦¬ì‚¬ì´ì € (ë“œë˜ê·¸ë¡œ í¬ê¸° ì¡°ì ˆ) -->
            <div class="resizer" id="resizer"></div>

            <!-- ë¯¸ë¦¬ë³´ê¸° íŒ¨ë„ (ì˜¤ë¥¸ìª½) -->
            <div class="preview-panel" id="previewPanel">
                <div class="panel-header">
                    <div class="panel-title">
                        ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°
                    </div>
                    <div class="preview-sizes">
                        <button class="preview-size-btn active" onclick="setPreviewSize('desktop')">ë°ìŠ¤í¬í†±</button>
                        <button class="preview-size-btn" onclick="setPreviewSize('tablet')">íƒœë¸”ë¦¿</button>
                        <button class="preview-size-btn" onclick="setPreviewSize('mobile')">ëª¨ë°”ì¼</button>
                    </div>
                </div>
                <div class="preview-wrapper">
                    <div class="preview-device desktop" id="previewDevice">
                        <iframe id="previewFrame" class="preview-frame"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>
    <div id="highlightTooltip" class="highlight-tooltip" style="display: none;"></div>

    <script>
        let currentFile = null;
        let originalContent = '';
        let isEditorOnLeft = true;  // í¸ì§‘ê¸°ê°€ ì™¼ìª½ì— ìˆëŠ”ì§€
        let previewUpdateTimer = null;
        let isSyncModeActive = false;  // ì—°ë™ ëª¨ë“œ ìƒíƒœ
        let lastHighlightedElement = null;  // ë§ˆì§€ë§‰ í•˜ì´ë¼ì´íŠ¸ëœ ìš”ì†Œ

        // íŒŒì¼ ëª©ë¡ ë¡œë“œ
        async function loadFiles() {
            try {
                const response = await fetch('/api/editor/files');
                const data = await response.json();

                if (data.success && data.files) {
                    const files = data.files.map(file => ({
                        name: file.name,
                        time: new Date(file.modified).toLocaleString(),
                        size: file.size
                    }));
                    displayFileList(files);
                } else {
                    displayFileList([]);
                }
            } catch (error) {
                console.error('íŒŒì¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                showNotification('íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                displayFileList([]);
            }
        }

        // íŒŒì¼ ëª©ë¡ í‘œì‹œ
        function displayFileList(files) {
            const fileList = document.getElementById('fileList');

            if (files.length === 0) {
                fileList.innerHTML = '<div style="padding: 15px; text-align: center; color: #888;">íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            fileList.innerHTML = files.map(file => `
                <div class="file-item" onclick="loadFile('${file.name}')">
                    <div class="file-name">${file.name}</div>
                    <div class="file-time">${file.time}</div>
                </div>
            `).join('');
        }

        // íŒŒì¼ ë¡œë“œ
        async function loadFile(filename) {
            try {
                const timestamp = new Date().getTime();
                const response = await fetch(`/outputs/${filename}?t=${timestamp}`, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                const content = await response.text();

                document.getElementById('htmlEditor').value = content;
                originalContent = content;
                currentFile = filename;

                document.querySelectorAll('.file-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.querySelector('.file-name').textContent === filename) {
                        item.classList.add('active');
                    }
                });

                updateStatus(`${filename} ë¡œë“œë¨`);
                updateCharCount();
                updatePreview();  // ì¦‰ì‹œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            } catch (error) {
                console.error('íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:', error);
                showNotification('íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
            }
        }

        // íŒŒì¼ ì €ì¥
        async function saveFile() {
            if (!currentFile) {
                showNotification('ì €ì¥í•  íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }

            const content = document.getElementById('htmlEditor').value;

            try {
                const response = await fetch(`/api/editor/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filename: currentFile,
                        content: content
                    })
                });

                if (response.ok) {
                    originalContent = content;
                    showNotification('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                    updateStatus(`${currentFile} ì €ì¥ë¨`);
                } else {
                    throw new Error('ì €ì¥ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('ì €ì¥ ì‹¤íŒ¨:', error);
                showNotification('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        function downloadFile() {
            if (!currentFile) {
                showNotification('ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }

            const content = document.getElementById('htmlEditor').value;
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFile;
            a.click();
            URL.revokeObjectURL(url);

            showNotification('ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }

        // ì¢Œìš° íŒ¨ë„ ì „í™˜ (ì™¼ì†ì¡ì´/ì˜¤ë¥¸ì†ì¡ì´ ì§€ì›)
        function swapPanels() {
            const container = document.getElementById('splitContainer');
            const editorPanel = document.getElementById('editorPanel');
            const previewPanel = document.getElementById('previewPanel');
            const resizer = document.getElementById('resizer');

            if (isEditorOnLeft) {
                // ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì™¼ìª½ìœ¼ë¡œ
                container.insertBefore(previewPanel, editorPanel);
                container.insertBefore(resizer, editorPanel);
                showNotification('ë¯¸ë¦¬ë³´ê¸°ê°€ ì™¼ìª½ìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤', 'success');
            } else {
                // í¸ì§‘ê¸°ë¥¼ ì™¼ìª½ìœ¼ë¡œ
                container.insertBefore(editorPanel, previewPanel);
                container.insertBefore(resizer, previewPanel);
                showNotification('í¸ì§‘ê¸°ê°€ ì™¼ìª½ìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤', 'success');
            }
            isEditorOnLeft = !isEditorOnLeft;

            // ì„¤ì • ì €ì¥
            localStorage.setItem('editorOnLeft', isEditorOnLeft);
        }

        // ë¯¸ë¦¬ë³´ê¸° í¬ê¸° ì„¤ì • (ë°ìŠ¤í¬í†±/íƒœë¸”ë¦¿/ëª¨ë°”ì¼)
        function setPreviewSize(size) {
            const device = document.getElementById('previewDevice');
            device.className = 'preview-device ' + size;

            document.querySelectorAll('.preview-size-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„ ë™ê¸°í™”)
        function updatePreview() {
            const content = document.getElementById('htmlEditor').value;
            const iframe = document.getElementById('previewFrame');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(content);
            iframeDoc.close();

            // ë™ê¸°í™” í‘œì‹œ ì—…ë°ì´íŠ¸
            const syncIndicator = document.getElementById('syncIndicator');
            syncIndicator.textContent = 'â— ë™ê¸°í™”ë¨';
            syncIndicator.classList.remove('syncing');
        }

        // ë””ë°”ìš´ìŠ¤ëœ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ (íƒ€ì´í•‘ ì¤‘ ì„±ëŠ¥ ìµœì í™”)
        function schedulePreviewUpdate() {
            const syncIndicator = document.getElementById('syncIndicator');
            syncIndicator.textContent = 'â—Œ ë™ê¸°í™” ì¤‘...';
            syncIndicator.classList.add('syncing');

            if (previewUpdateTimer) {
                clearTimeout(previewUpdateTimer);
            }
            previewUpdateTimer = setTimeout(() => {
                updatePreview();
            }, 300);  // 300ms ë””ë°”ìš´ìŠ¤
        }

        // HTML ì •ë¦¬
        function beautifyHTML() {
            const content = document.getElementById('htmlEditor').value;
            let beautified = content
                .replace(/>\s+</g, '>\n<')
                .replace(/\n\s*\n/g, '\n');

            document.getElementById('htmlEditor').value = beautified;
            showNotification('HTMLì´ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            updatePreview();
        }

        // ì°¾ê¸°/ë°”ê¾¸ê¸°
        function findReplace() {
            const find = prompt('ì°¾ì„ í…ìŠ¤íŠ¸:');
            if (!find) return;

            const replace = prompt('ë°”ê¿€ í…ìŠ¤íŠ¸:');
            if (replace === null) return;

            const content = document.getElementById('htmlEditor').value;
            const newContent = content.replaceAll(find, replace);
            document.getElementById('htmlEditor').value = newContent;

            const count = (content.match(new RegExp(find, 'g')) || []).length;
            showNotification(`${count}ê°œ í•­ëª©ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
            updatePreview();
        }

        // ì•Œë¦¼ í‘œì‹œ
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStatus(text) {
            document.getElementById('statusText').textContent = text;
        }

        // ê¸€ì ìˆ˜ ì—…ë°ì´íŠ¸
        function updateCharCount() {
            const content = document.getElementById('htmlEditor').value;
            document.getElementById('charCount').textContent = `${content.length.toLocaleString()} ì`;
        }

        // ë¦¬ì‚¬ì´ì € ë“œë˜ê·¸ ê¸°ëŠ¥
        function initResizer() {
            const resizer = document.getElementById('resizer');
            const editorPanel = document.getElementById('editorPanel');
            const previewPanel = document.getElementById('previewPanel');
            const container = document.getElementById('splitContainer');

            let isResizing = false;

            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const containerRect = container.getBoundingClientRect();
                const fileListWidth = document.getElementById('fileList').offsetWidth;
                const mouseX = e.clientX - containerRect.left;
                const containerWidth = containerRect.width;

                // ìµœì†Œ/ìµœëŒ€ í¬ê¸° ì œí•œ
                const minWidth = 300;
                const maxWidth = containerWidth - minWidth - 6;

                let leftPanelWidth = Math.max(minWidth, Math.min(mouseX, maxWidth));

                if (isEditorOnLeft) {
                    editorPanel.style.flex = 'none';
                    editorPanel.style.width = leftPanelWidth + 'px';
                    previewPanel.style.flex = '1';
                    previewPanel.style.width = 'auto';
                } else {
                    previewPanel.style.flex = 'none';
                    previewPanel.style.width = leftPanelWidth + 'px';
                    editorPanel.style.flex = '1';
                    editorPanel.style.width = 'auto';
                }
            });

            document.addEventListener('mouseup', () => {
                isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            });
        }

        // ì €ì¥ëœ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        function loadSettings() {
            const savedPosition = localStorage.getItem('editorOnLeft');
            if (savedPosition !== null && savedPosition === 'false') {
                swapPanels();
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('htmlEditor').addEventListener('input', () => {
            updateCharCount();
            schedulePreviewUpdate();  // ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° ë™ê¸°í™”
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            loadFiles();
            initResizer();
            loadSettings();
        });

        // ë‹¨ì¶•í‚¤
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveFile();
            }
        });

        // ==========================================
        // ì—°ë™ ëª¨ë“œ (ì—ë””í„° â†” ë¯¸ë¦¬ë³´ê¸° í•˜ì´ë¼ì´íŠ¸)
        // ==========================================

        // ì—°ë™ ëª¨ë“œ í† ê¸€
        function toggleSyncMode() {
            isSyncModeActive = !isSyncModeActive;
            const btn = document.getElementById('syncModeBtn');

            if (isSyncModeActive) {
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-success');
                btn.textContent = 'ğŸ”— ì—°ë™ëª¨ë“œ ON';
                showNotification('ì—°ë™ ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ì—°ê´€ ìœ„ì¹˜ê°€ í•˜ì´ë¼ì´íŠ¸ë©ë‹ˆë‹¤.', 'success');
                initSyncMode();
            } else {
                btn.classList.remove('btn-success');
                btn.classList.add('btn-secondary');
                btn.textContent = 'ğŸ”— ì—°ë™ëª¨ë“œ';
                showNotification('ì—°ë™ ëª¨ë“œê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                cleanupSyncMode();
            }
        }

        // ì—°ë™ ëª¨ë“œ ì´ˆê¸°í™”
        function initSyncMode() {
            const editor = document.getElementById('htmlEditor');
            const iframe = document.getElementById('previewFrame');

            // ì—ë””í„°ì—ì„œ ë§ˆìš°ìŠ¤ ì´ë™ ê°ì§€
            editor.addEventListener('mousemove', onEditorMouseMove);
            editor.addEventListener('mouseleave', onEditorMouseLeave);

            // ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ë§ˆìš°ìŠ¤ ì´ë™ ê°ì§€
            iframe.addEventListener('load', () => {
                if (isSyncModeActive) {
                    setupPreviewListeners();
                }
            });

            // í˜„ì¬ ë¡œë“œëœ ë¯¸ë¦¬ë³´ê¸°ì—ë„ ì ìš©
            setupPreviewListeners();
        }

        // ì—°ë™ ëª¨ë“œ ì •ë¦¬
        function cleanupSyncMode() {
            const editor = document.getElementById('htmlEditor');
            editor.removeEventListener('mousemove', onEditorMouseMove);
            editor.removeEventListener('mouseleave', onEditorMouseLeave);

            // í•˜ì´ë¼ì´íŠ¸ ì œê±°
            clearAllHighlights();
            hideTooltip();
        }

        // ë¯¸ë¦¬ë³´ê¸° iframeì— ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupPreviewListeners() {
            const iframe = document.getElementById('previewFrame');
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                // ë¯¸ë¦¬ë³´ê¸° ë‚´ ìš”ì†Œì— ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ì¶”ê°€
                iframeDoc.body.addEventListener('mouseover', onPreviewMouseOver);
                iframeDoc.body.addEventListener('mouseout', onPreviewMouseOut);

                // í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ ì£¼ì…
                injectHighlightStyles(iframeDoc);
            } catch (e) {
                console.log('ë¯¸ë¦¬ë³´ê¸° ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹¤íŒ¨:', e);
            }
        }

        // ë¯¸ë¦¬ë³´ê¸°ì— í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ ì£¼ì…
        function injectHighlightStyles(doc) {
            if (doc.getElementById('syncHighlightStyles')) return;

            const style = doc.createElement('style');
            style.id = 'syncHighlightStyles';
            style.textContent = `
                .sync-highlight {
                    outline: 3px solid #FBBF24 !important;
                    outline-offset: 2px !important;
                    background-color: rgba(251, 191, 36, 0.2) !important;
                    transition: all 0.15s ease !important;
                }
                .sync-highlight * {
                    background-color: rgba(251, 191, 36, 0.1) !important;
                }
            `;
            doc.head.appendChild(style);
        }

        // ì—ë””í„°ì—ì„œ ë§ˆìš°ìŠ¤ ì´ë™ ì‹œ
        function onEditorMouseMove(e) {
            if (!isSyncModeActive) return;

            const editor = e.target;
            const content = editor.value;

            // ì»¤ì„œ ìœ„ì¹˜ ê³„ì‚°
            const cursorPos = editor.selectionStart;

            // í˜„ì¬ ì¤„ ì°¾ê¸°
            const textBeforeCursor = content.substring(0, cursorPos);
            const currentLine = textBeforeCursor.split('\n').length;

            // í˜„ì¬ ì¤„ì˜ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
            const lines = content.split('\n');
            const lineContent = lines[currentLine - 1] || '';

            // HTML íƒœê·¸ ì°¾ê¸°
            const tagMatch = lineContent.match(/<(\w+)[^>]*(?:class="([^"]*)")?[^>]*>/);

            if (tagMatch) {
                const tagName = tagMatch[1];
                const className = tagMatch[2];

                // ë¯¸ë¦¬ë³´ê¸°ì—ì„œ í•´ë‹¹ ìš”ì†Œ ì°¾ì•„ì„œ í•˜ì´ë¼ì´íŠ¸
                highlightInPreview(tagName, className, lineContent, currentLine);

                // íˆ´íŒ í‘œì‹œ
                showTooltip(e.clientX, e.clientY - 30, `${tagName}${className ? '.' + className.split(' ')[0] : ''} (ì¤„ ${currentLine})`);
            } else {
                clearPreviewHighlight();
                hideTooltip();
            }
        }

        // ì—ë””í„°ì—ì„œ ë§ˆìš°ìŠ¤ê°€ ë‚˜ê°ˆ ë•Œ
        function onEditorMouseLeave() {
            clearPreviewHighlight();
            hideTooltip();
        }

        // ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ
        function onPreviewMouseOver(e) {
            if (!isSyncModeActive) return;

            const element = e.target;
            if (element.tagName === 'HTML' || element.tagName === 'BODY') return;

            // ìš”ì†Œ í•˜ì´ë¼ì´íŠ¸
            element.classList.add('sync-highlight');
            lastHighlightedElement = element;

            // ì—ë””í„°ì—ì„œ í•´ë‹¹ ìš”ì†Œ ì°¾ê¸°
            highlightInEditor(element);

            // íˆ´íŒ í‘œì‹œ (iframe ë‚´ ì¢Œí‘œë¥¼ í˜ì´ì§€ ì¢Œí‘œë¡œ ë³€í™˜)
            const iframe = document.getElementById('previewFrame');
            const iframeRect = iframe.getBoundingClientRect();
            const tagInfo = getElementInfo(element);
            showTooltip(e.clientX + iframeRect.left, e.clientY + iframeRect.top - 30, tagInfo);
        }

        // ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ë§ˆìš°ìŠ¤ ì•„ì›ƒ ì‹œ
        function onPreviewMouseOut(e) {
            if (!isSyncModeActive) return;

            const element = e.target;
            element.classList.remove('sync-highlight');

            clearEditorHighlight();
            hideTooltip();
        }

        // ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ìš”ì†Œ í•˜ì´ë¼ì´íŠ¸
        function highlightInPreview(tagName, className, lineContent, lineNum) {
            const iframe = document.getElementById('previewFrame');
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                // ì´ì „ í•˜ì´ë¼ì´íŠ¸ ì œê±°
                clearPreviewHighlight();

                // ìš”ì†Œ ì°¾ê¸°
                let elements;
                if (className) {
                    elements = iframeDoc.querySelectorAll(`${tagName}.${className.split(' ')[0]}`);
                } else {
                    elements = iframeDoc.querySelectorAll(tagName);
                }

                // í…ìŠ¤íŠ¸ ë‚´ìš©ìœ¼ë¡œ ë” ì •í™•í•˜ê²Œ ì°¾ê¸°
                const textMatch = lineContent.match(/>([^<]+)</);
                const searchText = textMatch ? textMatch[1].trim() : '';

                if (elements.length > 0) {
                    let targetElement = elements[0];

                    // í…ìŠ¤íŠ¸ë¡œ ë” ì •í™•í•œ ìš”ì†Œ ì°¾ê¸°
                    if (searchText) {
                        for (let el of elements) {
                            if (el.textContent.includes(searchText)) {
                                targetElement = el;
                                break;
                            }
                        }
                    }

                    targetElement.classList.add('sync-highlight');
                    lastHighlightedElement = targetElement;

                    // ìŠ¤í¬ë¡¤í•´ì„œ ë³´ì´ê²Œ
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            } catch (e) {
                console.log('ë¯¸ë¦¬ë³´ê¸° í•˜ì´ë¼ì´íŠ¸ ì‹¤íŒ¨:', e);
            }
        }

        // ì—ë””í„°ì—ì„œ í•´ë‹¹ ìš”ì†Œ ìœ„ì¹˜ í•˜ì´ë¼ì´íŠ¸
        function highlightInEditor(element) {
            const editor = document.getElementById('htmlEditor');
            const content = editor.value;

            // ìš”ì†Œì˜ íƒœê·¸ëª…ê³¼ í´ë˜ìŠ¤ë¡œ ê²€ìƒ‰
            const tagName = element.tagName.toLowerCase();
            const className = element.className.replace('sync-highlight', '').trim().split(' ')[0];
            const textContent = element.textContent.trim().substring(0, 30);

            // ì •ê·œì‹ìœ¼ë¡œ í•´ë‹¹ íƒœê·¸ ì°¾ê¸°
            let searchPattern;
            if (className) {
                searchPattern = new RegExp(`<${tagName}[^>]*class="[^"]*${className}[^"]*"[^>]*>`, 'gi');
            } else if (textContent) {
                // í…ìŠ¤íŠ¸ë¡œ ì°¾ê¸°
                const escapedText = textContent.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                searchPattern = new RegExp(`<${tagName}[^>]*>[^<]*${escapedText}`, 'gi');
            } else {
                searchPattern = new RegExp(`<${tagName}[^>]*>`, 'gi');
            }

            const match = searchPattern.exec(content);
            if (match) {
                const startPos = match.index;
                const endPos = startPos + match[0].length;

                // í•´ë‹¹ ì¤„ ë²ˆí˜¸ ê³„ì‚°
                const textBefore = content.substring(0, startPos);
                const lineNum = textBefore.split('\n').length;

                // ì—ë””í„° ìŠ¤í¬ë¡¤
                const lineHeight = 18; // ëŒ€ëµì ì¸ ì¤„ ë†’ì´
                editor.scrollTop = (lineNum - 5) * lineHeight;

                // ì„ íƒ í‘œì‹œ (ì‹œê°ì  í•˜ì´ë¼ì´íŠ¸)
                editor.setSelectionRange(startPos, endPos);
                editor.focus();
            }
        }

        // ë¯¸ë¦¬ë³´ê¸° í•˜ì´ë¼ì´íŠ¸ ì œê±°
        function clearPreviewHighlight() {
            if (lastHighlightedElement) {
                lastHighlightedElement.classList.remove('sync-highlight');
                lastHighlightedElement = null;
            }

            const iframe = document.getElementById('previewFrame');
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                iframeDoc.querySelectorAll('.sync-highlight').forEach(el => {
                    el.classList.remove('sync-highlight');
                });
            } catch (e) {}
        }

        // ì—ë””í„° í•˜ì´ë¼ì´íŠ¸ ì œê±°
        function clearEditorHighlight() {
            // ì„ íƒ í•´ì œ
            const editor = document.getElementById('htmlEditor');
            const pos = editor.selectionStart;
            editor.setSelectionRange(pos, pos);
        }

        // ëª¨ë“  í•˜ì´ë¼ì´íŠ¸ ì œê±°
        function clearAllHighlights() {
            clearPreviewHighlight();
            clearEditorHighlight();
        }

        // ìš”ì†Œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        function getElementInfo(element) {
            const tag = element.tagName.toLowerCase();
            const id = element.id ? `#${element.id}` : '';
            const className = element.className.replace('sync-highlight', '').trim();
            const classStr = className ? `.${className.split(' ')[0]}` : '';
            return `<${tag}${id}${classStr}>`;
        }

        // íˆ´íŒ í‘œì‹œ
        function showTooltip(x, y, text) {
            const tooltip = document.getElementById('highlightTooltip');
            tooltip.textContent = text;
            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
            tooltip.style.display = 'block';
        }

        // íˆ´íŒ ìˆ¨ê¸°ê¸°
        function hideTooltip() {
            const tooltip = document.getElementById('highlightTooltip');
            tooltip.style.display = 'none';
        }

        // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ í›„ ì—°ë™ ëª¨ë“œ ë¦¬ìŠ¤ë„ˆ ì¬ì„¤ì •
        const originalUpdatePreview = updatePreview;
        updatePreview = function() {
            originalUpdatePreview();
            if (isSyncModeActive) {
                setTimeout(setupPreviewListeners, 100);
            }
        };
    </script>
</body>
</html>
