<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudySnap HTML Editor</title>
    <!-- JSZip for ZIP download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
        }

        .editor-header {
            background: white;
            border-bottom: 1px solid #ddd;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .editor-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .editor-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #E11D48;
            color: white;
        }

        .btn-primary:hover {
            background: #BE123C;
        }

        .btn-secondary {
            background: #6B7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4B5563;
        }

        .btn-success {
            background: #10B981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .editor-container {
            display: flex;
            height: calc(100vh - 70px);
        }

        .file-list {
            width: 200px;
            min-width: 150px;
            background: white;
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }

        .file-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .file-item:hover {
            background: #f9fafb;
        }

        .file-item.active {
            background: #E11D4820;
            border-left: 3px solid #E11D48;
        }

        /* í´ë” ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .folder-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            background: #fefce8;
        }

        .folder-item:hover {
            background: #fef3c7;
        }

        .folder-item .folder-icon {
            font-size: 1.1em;
        }

        .folder-item .folder-name {
            font-size: 0.85em;
            color: #92400e;
            font-weight: 500;
        }

        /* ë¸Œë ˆë“œí¬ëŸ¼ ë„¤ë¹„ê²Œì´ì…˜ */
        .breadcrumb {
            padding: 10px 12px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
        }

        .breadcrumb-item {
            color: #3B82F6;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .breadcrumb-item:hover {
            background: #dbeafe;
            text-decoration: underline;
        }

        .breadcrumb-separator {
            color: #9ca3af;
        }

        .breadcrumb-current {
            color: #374151;
            font-weight: 600;
        }

        .file-name {
            font-size: 0.85em;
            color: #333;
            margin-bottom: 3px;
            word-break: break-all;
        }

        .file-time {
            font-size: 0.7em;
            color: #888;
        }

        /* ì¢Œìš° ë¶„í•  ë ˆì´ì•„ì›ƒ */
        .split-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .editor-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-right: 1px solid #ddd;
            min-width: 300px;
        }

        .preview-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f9fafb;
            min-width: 300px;
        }

        .panel-header {
            padding: 10px 15px;
            background: #f3f4f6;
            border-bottom: 1px solid #ddd;
            font-weight: 600;
            font-size: 0.9em;
            color: #374151;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header .panel-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ë¦¬ì‚¬ì´ì € */
        .resizer {
            width: 6px;
            background: #e5e7eb;
            cursor: col-resize;
            transition: background 0.2s;
        }

        .resizer:hover {
            background: #E11D48;
        }

        .toolbar {
            padding: 8px 10px;
            background: #f9fafb;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            padding: 5px 10px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .toolbar-btn:hover {
            background: #f3f4f6;
        }

        .editor-content {
            flex: 1;
            overflow: hidden;
            padding: 10px;
        }

        #htmlEditor {
            width: 100%;
            height: 100%;
            border: 1px solid #ddd;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            resize: none;
            background: #fefefe;
        }

        .preview-content {
            flex: 1;
            overflow: hidden;
            background: white;
            margin: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .preview-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        .status-bar {
            padding: 6px 15px;
            background: #f9fafb;
            border-top: 1px solid #ddd;
            font-size: 0.8em;
            color: #666;
            display: flex;
            justify-content: space-between;
        }

        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 12px 20px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            z-index: 2000;
        }

        .notification.show {
            display: block;
            animation: slideIn 0.3s;
        }

        .notification.success {
            border-left: 4px solid #10B981;
        }

        .notification.error {
            border-left: 4px solid #EF4444;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ë™ê¸°í™” í‘œì‹œ */
        .sync-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75em;
            color: #10B981;
        }

        .sync-indicator.syncing {
            color: #F59E0B;
        }

        /* ëª¨ë°”ì¼ í”„ë¦¬ë·° ì˜µì…˜ */
        .preview-size-btn {
            padding: 4px 8px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.75em;
        }

        .preview-size-btn.active {
            background: #E11D48;
            color: white;
            border-color: #E11D48;
        }

        .preview-sizes {
            display: flex;
            gap: 5px;
        }

        /* ë¯¸ë¦¬ë³´ê¸° í¬ê¸° ì¡°ì ˆ */
        .preview-wrapper {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow: auto;
            padding: 10px;
            background: #e5e7eb;
        }

        .preview-device {
            background: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            overflow: hidden;
            transition: all 0.3s;
        }

        .preview-device.desktop {
            width: 100%;
            height: 100%;
        }

        .preview-device.tablet {
            width: 768px;
            height: 100%;
            border-radius: 8px;
        }

        .preview-device.mobile {
            width: 375px;
            height: 100%;
            border-radius: 20px;
            border: 8px solid #333;
        }

        /* ì—ë””í„°-ë¯¸ë¦¬ë³´ê¸° ì—°ë™ í•˜ì´ë¼ì´íŠ¸ */
        .editor-highlight {
            background: linear-gradient(90deg, #FBBF24 0%, #FDE68A 100%);
            border-radius: 2px;
        }

        #htmlEditor.line-highlight {
            background-image: linear-gradient(
                transparent 0,
                transparent calc(var(--highlight-line) * 1.5em - 0.75em),
                rgba(251, 191, 36, 0.3) calc(var(--highlight-line) * 1.5em - 0.75em),
                rgba(251, 191, 36, 0.3) calc(var(--highlight-line) * 1.5em + 0.75em),
                transparent calc(var(--highlight-line) * 1.5em + 0.75em)
            );
        }

        /* ì—°ë™ ëª¨ë“œ í‘œì‹œ */
        .sync-mode-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 8px;
            background: #FEF3C7;
            border: 1px solid #F59E0B;
            border-radius: 4px;
            font-size: 0.7em;
            color: #92400E;
            margin-left: 10px;
        }

        .sync-mode-indicator.active {
            background: #D1FAE5;
            border-color: #10B981;
            color: #065F46;
        }

        /* í•˜ì´ë¼ì´íŠ¸ íˆ´íŒ */
        .highlight-tooltip {
            position: fixed;
            background: #1F2937;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            z-index: 9999;
            pointer-events: none;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .highlight-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1F2937 transparent transparent transparent;
        }

        /* ìš”ì†Œ ì„ íƒ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
        .element-selected {
            outline: 3px solid #3B82F6 !important;
            outline-offset: 2px !important;
            background-color: rgba(59, 130, 246, 0.1) !important;
            cursor: move !important;
        }

        .element-moveable:hover {
            outline: 2px dashed #9CA3AF !important;
            outline-offset: 1px !important;
        }

        /* ì´ë™ ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .move-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 10001;
            display: none;
        }

        .move-controls.active {
            display: block;
        }

        .move-controls-title {
            font-weight: 600;
            font-size: 0.85em;
            color: #374151;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .move-controls-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #9CA3AF;
        }

        .move-controls-close:hover {
            color: #374151;
        }

        .move-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .move-btn {
            width: 40px;
            height: 40px;
            border: 1px solid #E5E7EB;
            background: #F9FAFB;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .move-btn:hover {
            background: #3B82F6;
            color: white;
            border-color: #3B82F6;
        }

        .move-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .move-btn.center {
            background: #3B82F6;
            color: white;
            border-color: #3B82F6;
        }

        .move-info {
            font-size: 0.75em;
            color: #6B7280;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #E5E7EB;
        }

        .selected-element-info {
            background: #F0F9FF;
            border: 1px solid #BAE6FD;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 10px;
            font-size: 0.8em;
            color: #0369A1;
            max-width: 200px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="editor-header">
        <div style="display: flex; align-items: center; gap: 20px;">
            <div class="editor-title">ğŸ“ StudySnap HTML Editor</div>
            <nav style="display: flex; gap: 8px;">
                <a href="/static/explorer.html" style="padding: 6px 12px; background: #1e3c72; color: white; text-decoration: none; border-radius: 5px; font-size: 0.85em;">ğŸ—‚ï¸ íƒìƒ‰ê¸°</a>
                <a href="/static/files.html" style="padding: 6px 12px; background: #6B7280; color: white; text-decoration: none; border-radius: 5px; font-size: 0.85em;">ğŸ“ íŒŒì¼</a>
                <a href="/static/auto-converter.html" style="padding: 6px 12px; background: #10B981; color: white; text-decoration: none; border-radius: 5px; font-size: 0.85em;">ğŸ¤– ë³€í™˜</a>
            </nav>
        </div>
        <div class="editor-controls">
            <button class="btn btn-primary" onclick="openPdfUpload()" style="background: #8B5CF6;" title="ë¡œì»¬ PDF íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ HTMLë¡œ ë³€í™˜">ğŸ“„ PDF ë³€í™˜</button>
            <button class="btn btn-primary" onclick="openHtmlUpload()" style="background: #F59E0B;" title="ë¡œì»¬ HTML íŒŒì¼ì„ ì„œë²„ì— ì—…ë¡œë“œ">ğŸ“¤ HTML ì—…ë¡œë“œ</button>
            <button class="btn btn-secondary" onclick="swapPanels()" title="í¸ì§‘/ë¯¸ë¦¬ë³´ê¸° ìœ„ì¹˜ ë°”ê¾¸ê¸°">â†”ï¸ ì¢Œìš°ì „í™˜</button>
            <button class="btn btn-secondary" onclick="toggleSyncMode()" id="syncModeBtn" title="ë§ˆìš°ìŠ¤ ìœ„ì¹˜ì— ë”°ë¼ í¸ì§‘ê¸°â†”ë¯¸ë¦¬ë³´ê¸° ì—°ë™ í•˜ì´ë¼ì´íŠ¸">ğŸ”— ì—°ë™ëª¨ë“œ</button>
            <button class="btn btn-secondary" onclick="loadFiles()">ìƒˆë¡œê³ ì¹¨</button>
            <button class="btn btn-success" onclick="saveFile()">ğŸ’¾ ì €ì¥</button>
            <button class="btn btn-primary" onclick="downloadFile()">â¬‡ï¸ ë‹¤ìš´ë¡œë“œ</button>
            <button class="btn btn-success" onclick="downloadWithImages()" style="background: #059669;">ğŸ“¦ ZIP ë‹¤ìš´ë¡œë“œ</button>
            <button class="btn btn-secondary" onclick="openFeedbackModal()" style="background: #8B5CF6;">ğŸ§  AI í”¼ë“œë°±</button>
        </div>

        <!-- ìˆ¨ê²¨ì§„ HTML íŒŒì¼ ì—…ë¡œë“œ input -->
        <input type="file" id="htmlFileInput" accept=".html" style="display: none;" onchange="uploadHtmlFile(this.files[0])" />
    </div>

    <div class="editor-container">
        <div class="file-list">
            <div id="breadcrumb" class="breadcrumb">
                <span class="breadcrumb-current">ğŸ“ outputs</span>
            </div>
            <div id="fileListContent">
                <div style="padding: 15px; text-align: center; color: #888;">
                    ğŸ“‚ íŒŒì¼ ëª©ë¡ ë¡œë”© ì¤‘...
                </div>
            </div>
        </div>

        <!-- ì¢Œìš° ë¶„í•  ì»¨í…Œì´ë„ˆ -->
        <div class="split-container" id="splitContainer">
            <!-- í¸ì§‘ íŒ¨ë„ (ì™¼ìª½) -->
            <div class="editor-panel" id="editorPanel">
                <div class="panel-header">
                    <div class="panel-title">
                        âœï¸ í¸ì§‘
                    </div>
                    <span class="sync-indicator" id="syncIndicator">â— ë™ê¸°í™”ë¨</span>
                </div>
                <div class="toolbar">
                    <button class="toolbar-btn" onclick="formatText('bold')"><b>B</b></button>
                    <button class="toolbar-btn" onclick="formatText('italic')"><i>I</i></button>
                    <button class="toolbar-btn" onclick="formatText('underline')"><u>U</u></button>
                    <span style="border-left: 1px solid #ddd; margin: 0 5px;"></span>
                    <button class="toolbar-btn" onclick="insertElement('h1')">ì œëª©1</button>
                    <button class="toolbar-btn" onclick="insertElement('h2')">ì œëª©2</button>
                    <button class="toolbar-btn" onclick="insertElement('p')">ë³¸ë¬¸</button>
                    <span style="border-left: 1px solid #ddd; margin: 0 5px;"></span>
                    <button class="toolbar-btn" onclick="beautifyHTML()">ì½”ë“œ ì •ë¦¬</button>
                    <button class="toolbar-btn" onclick="findReplace()">ì°¾ê¸°/ë°”ê¾¸ê¸°</button>
                    <span style="border-left: 1px solid #ddd; margin: 0 5px;"></span>
                    <button class="toolbar-btn" onclick="openImageUpload()" style="background: #10B981; color: white;">ğŸ–¼ï¸ ì´ë¯¸ì§€</button>
                    <button class="toolbar-btn" onclick="insertLink()">ğŸ”— ë§í¬</button>
                    <span style="border-left: 1px solid #ddd; margin: 0 5px;"></span>
                    <button class="toolbar-btn" onclick="openValidation()" style="background: #8B5CF6; color: white;">ğŸ” í…ìŠ¤íŠ¸ ê²€ì¦</button>
                </div>
                <div class="editor-content">
                    <textarea id="htmlEditor" placeholder="HTML íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”..."></textarea>
                </div>
                <div class="status-bar">
                    <span id="statusText">íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</span>
                    <span id="charCount">0 ì</span>
                </div>
            </div>

            <!-- ë¦¬ì‚¬ì´ì € (ë“œë˜ê·¸ë¡œ í¬ê¸° ì¡°ì ˆ) -->
            <div class="resizer" id="resizer"></div>

            <!-- ë¯¸ë¦¬ë³´ê¸° íŒ¨ë„ (ì˜¤ë¥¸ìª½) -->
            <div class="preview-panel" id="previewPanel">
                <div class="panel-header">
                    <div class="panel-title">
                        ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°
                    </div>
                    <div class="preview-sizes">
                        <button class="preview-size-btn active" onclick="setPreviewSize('desktop')">ë°ìŠ¤í¬í†±</button>
                        <button class="preview-size-btn" onclick="setPreviewSize('tablet')">íƒœë¸”ë¦¿</button>
                        <button class="preview-size-btn" onclick="setPreviewSize('mobile')">ëª¨ë°”ì¼</button>
                    </div>
                </div>
                <div class="preview-wrapper">
                    <div class="preview-device desktop" id="previewDevice">
                        <iframe id="previewFrame" class="preview-frame"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>
    <div id="highlightTooltip" class="highlight-tooltip" style="display: none;"></div>

    <!-- ìš”ì†Œ ì´ë™ ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
    <div id="moveControls" class="move-controls">
        <div class="move-controls-title">
            <span>ìš”ì†Œ ì´ë™</span>
            <button class="move-controls-close" onclick="deselectElement()">&times;</button>
        </div>
        <div id="selectedElementInfo" class="selected-element-info"></div>
        <div class="move-grid">
            <div></div>
            <button class="move-btn" onclick="moveElement('up')" title="ìœ„ë¡œ ì´ë™">â¬†ï¸</button>
            <div></div>
            <button class="move-btn" onclick="moveElement('left')" title="ì™¼ìª½ìœ¼ë¡œ ì´ë™ (ë“¤ì—¬ì“°ê¸°)">â¬…ï¸</button>
            <button class="move-btn center" title="ì„ íƒëœ ìš”ì†Œ">â—</button>
            <button class="move-btn" onclick="moveElement('right')" title="ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™ (ë‚´ì–´ì“°ê¸°)">â¡ï¸</button>
            <div></div>
            <button class="move-btn" onclick="moveElement('down')" title="ì•„ë˜ë¡œ ì´ë™">â¬‡ï¸</button>
            <div></div>
        </div>
        <div style="display: flex; gap: 5px; margin-top: 10px;">
            <button class="move-btn" style="flex:1; width:auto;" onclick="deleteElement()" title="ìš”ì†Œ ì‚­ì œ">ğŸ—‘ï¸ ì‚­ì œ</button>
            <button class="move-btn" style="flex:1; width:auto;" onclick="duplicateElement()" title="ìš”ì†Œ ë³µì œ">ğŸ“‹ ë³µì œ</button>
        </div>
        <div class="move-info">
            í‚¤ë³´ë“œ: â†‘â†“â†â†’ ì´ë™, Delete ì‚­ì œ, Esc ì·¨ì†Œ
        </div>
    </div>

    <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ ëª¨ë‹¬ -->
    <div id="imageModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 12px; padding: 25px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #333;">ğŸ–¼ï¸ ì´ë¯¸ì§€ ì‚½ì…</h3>
                <button onclick="closeImageModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>

            <!-- íƒ­ -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button onclick="switchImageTab('upload')" id="tabUpload" style="flex: 1; padding: 10px; border: 2px solid #10B981; background: #10B981; color: white; border-radius: 8px; cursor: pointer; font-weight: 600;">ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ</button>
                <button onclick="switchImageTab('url')" id="tabUrl" style="flex: 1; padding: 10px; border: 2px solid #ddd; background: white; color: #666; border-radius: 8px; cursor: pointer; font-weight: 600;">ğŸ”— URL ì…ë ¥</button>
                <button onclick="switchImageTab('gallery')" id="tabGallery" style="flex: 1; padding: 10px; border: 2px solid #ddd; background: white; color: #666; border-radius: 8px; cursor: pointer; font-weight: 600;">ğŸ“ ì„œë²„ ì´ë¯¸ì§€</button>
            </div>

            <!-- ì—…ë¡œë“œ íƒ­ -->
            <div id="uploadTab">
                <div style="border: 2px dashed #ddd; border-radius: 8px; padding: 40px; text-align: center; margin-bottom: 15px; cursor: pointer; transition: all 0.3s;"
                     onclick="document.getElementById('imageFileInput').click()"
                     ondragover="this.style.borderColor='#10B981'; this.style.background='#f0fdf4'; event.preventDefault();"
                     ondragleave="this.style.borderColor='#ddd'; this.style.background='white';"
                     ondrop="handleImageDrop(event)">
                    <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“</div>
                    <p style="margin: 0; color: #666;">í´ë¦­í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                    <p style="margin: 5px 0 0; color: #999; font-size: 12px;">JPG, PNG, GIF, WebP (ìµœëŒ€ 10MB)</p>
                </div>
                <input type="file" id="imageFileInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                <div id="uploadPreview" style="display: none; margin-bottom: 15px; text-align: center;">
                    <img id="previewImg" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;">
                    <p id="previewFileName" style="margin: 10px 0 0; color: #666; font-size: 13px;"></p>
                </div>
            </div>

            <!-- URL íƒ­ -->
            <div id="urlTab" style="display: none;">
                <input type="text" id="imageUrlInput" placeholder="https://example.com/image.jpg" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; margin-bottom: 15px;">
                <div id="urlPreview" style="display: none; margin-bottom: 15px; text-align: center;">
                    <img id="urlPreviewImg" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;">
                </div>
                <button onclick="previewUrlImage()" style="width: 100%; padding: 10px; background: #3B82F6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">ë¯¸ë¦¬ë³´ê¸°</button>
            </div>

            <!-- ì„œë²„ ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ íƒ­ -->
            <div id="galleryTab" style="display: none;">
                <div id="serverImages" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-height: 300px; overflow-y: auto;">
                    <!-- ì„œë²„ ì´ë¯¸ì§€ ëª©ë¡ì´ ì—¬ê¸°ì— ë¡œë“œë¨ -->
                </div>
            </div>

            <!-- ì˜µì…˜ -->
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 500;">ëŒ€ì²´ í…ìŠ¤íŠ¸ (alt):</label>
                <input type="text" id="imageAltText" placeholder="ì´ë¯¸ì§€ ì„¤ëª…" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
            </div>

            <!-- ë²„íŠ¼ -->
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="closeImageModal()" style="flex: 1; padding: 12px; background: #f3f4f6; color: #666; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">ì·¨ì†Œ</button>
                <button onclick="insertImage()" style="flex: 1; padding: 12px; background: #10B981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">ì‚½ì…</button>
            </div>
        </div>
    </div>

    <!-- í…ìŠ¤íŠ¸ ê²€ì¦ ëª¨ë‹¬ -->
    <div id="validationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 12px; padding: 25px; max-width: 800px; width: 95%; max-height: 90vh; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3); display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #333;">ğŸ” í…ìŠ¤íŠ¸ ê²€ì¦</h3>
                <button onclick="closeValidationModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>

            <div style="display: flex; gap: 15px; margin-bottom: 15px; flex: 1; overflow: hidden;">
                <!-- ì›ë³¸ í…ìŠ¤íŠ¸ -->
                <div style="flex: 1; display: flex; flex-direction: column;">
                    <label style="font-weight: 600; margin-bottom: 8px; color: #333;">ğŸ“„ ì›ë³¸ í…ìŠ¤íŠ¸ (PDF ì›ë³¸)</label>
                    <textarea id="originalText" placeholder="ì›ë³¸ PDFì˜ í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..." style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; resize: none; font-family: inherit; font-size: 14px; line-height: 1.6;"></textarea>
                </div>

                <!-- ë³€í™˜ëœ í…ìŠ¤íŠ¸ -->
                <div style="flex: 1; display: flex; flex-direction: column;">
                    <label style="font-weight: 600; margin-bottom: 8px; color: #333;">ğŸ“ ë³€í™˜ëœ í…ìŠ¤íŠ¸ (í˜„ì¬ HTML)</label>
                    <textarea id="convertedText" placeholder="ë³€í™˜ëœ HTMLì˜ í…ìŠ¤íŠ¸..." style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; resize: none; font-family: inherit; font-size: 14px; line-height: 1.6;" readonly></textarea>
                    <button onclick="extractHtmlText()" style="margin-top: 8px; padding: 8px; background: #6B7280; color: white; border: none; border-radius: 5px; cursor: pointer;">í˜„ì¬ HTMLì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ</button>
                </div>
            </div>

            <!-- ê²€ì¦ ë²„íŠ¼ -->
            <div style="text-align: center; margin-bottom: 15px;">
                <button onclick="runValidation()" style="padding: 12px 40px; background: #8B5CF6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">ğŸ” ê²€ì¦ ì‹¤í–‰</button>
            </div>

            <!-- ê²€ì¦ ê²°ê³¼ -->
            <div id="validationResult" style="max-height: 300px; overflow-y: auto; border: 2px solid #ddd; border-radius: 8px; padding: 15px; background: #f9fafb; display: none;">
                <div id="validationSummary" style="margin-bottom: 15px;"></div>
                <div id="validationErrors"></div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬ (ë””ë²„ê¹…ìš©)
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('JavaScript ì˜¤ë¥˜:', msg, 'at', url, lineNo);
            const fileList = document.getElementById('fileList');
            if (fileList) {
                fileList.innerHTML = `<div style="padding: 15px; text-align: center; color: #E11D48;">
                    âŒ JS ì˜¤ë¥˜ ë°œìƒ<br>
                    <small>${msg}</small><br>
                    <small>Line: ${lineNo}</small>
                </div>`;
            }
            return false;
        };

        // ë²„ì „ í‘œì‹œ (ë””ë²„ê¹…ìš©)
        console.log('Editor version: 2024-12-05-v2');

        let currentFile = null;
        let originalContent = '';
        let isEditorOnLeft = true;  // í¸ì§‘ê¸°ê°€ ì™¼ìª½ì— ìˆëŠ”ì§€
        let previewUpdateTimer = null;
        let isSyncModeActive = false;  // ì—°ë™ ëª¨ë“œ ìƒíƒœ
        let lastHighlightedElement = null;  // ë§ˆì§€ë§‰ í•˜ì´ë¼ì´íŠ¸ëœ ìš”ì†Œ
        let currentPath = '';  // í˜„ì¬ íƒìƒ‰ ì¤‘ì¸ í•˜ìœ„ ê²½ë¡œ

        // ë¸Œë ˆë“œí¬ëŸ¼ ì—…ë°ì´íŠ¸
        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            if (!currentPath) {
                breadcrumb.innerHTML = '<span class="breadcrumb-current">ğŸ“ outputs</span>';
                return;
            }

            const parts = currentPath.split('/').filter(p => p);
            let html = '<span class="breadcrumb-item" onclick="navigateTo(\'\')">ğŸ“ outputs</span>';

            let accumulated = '';
            parts.forEach((part, idx) => {
                html += '<span class="breadcrumb-separator">/</span>';
                accumulated += (accumulated ? '/' : '') + part;
                if (idx === parts.length - 1) {
                    html += `<span class="breadcrumb-current">${part}</span>`;
                } else {
                    const pathToGo = accumulated;
                    html += `<span class="breadcrumb-item" onclick="navigateTo('${pathToGo}')">${part}</span>`;
                }
            });

            breadcrumb.innerHTML = html;
        }

        // íŠ¹ì • ê²½ë¡œë¡œ ì´ë™
        function navigateTo(path) {
            currentPath = path;
            loadFiles();
        }

        // íŒŒì¼ ëª©ë¡ ë¡œë“œ (í´ë” ì§€ì›)
        async function loadFiles() {
            const fileListContent = document.getElementById('fileListContent');

            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            fileListContent.innerHTML = '<div style="padding: 15px; text-align: center; color: #888;">ğŸ“‚ íŒŒì¼ ëª©ë¡ ë¡œë”© ì¤‘...</div>';
            updateBreadcrumb();

            try {
                console.log('íŒŒì¼ ëª©ë¡ ë¡œë“œ ì‹œì‘... currentPath:', currentPath);
                // ìƒˆë¡œìš´ API ì‚¬ìš© (í´ë” ì§€ì›)
                let apiUrl = '/api/files/outputs';
                if (currentPath) {
                    apiUrl += '/' + currentPath;
                }
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('íŒŒì¼ ëª©ë¡ ì‘ë‹µ:', data);

                if (data.success) {
                    const folders = data.folders || [];
                    const files = (data.files || []).map(file => ({
                        name: file.name,
                        time: new Date(file.modified).toLocaleString(),
                        size: file.size
                    }));
                    displayFoldersAndFiles(folders, files);
                    console.log(`${folders.length}ê°œ í´ë”, ${files.length}ê°œ íŒŒì¼ ë¡œë“œ ì™„ë£Œ`);
                } else {
                    fileListContent.innerHTML = '<div style="padding: 15px; text-align: center; color: #888;">ğŸ“ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤<br><small>PDFë¥¼ ì—…ë¡œë“œí•˜ê±°ë‚˜ outputs í´ë”ì— HTML íŒŒì¼ì„ ì¶”ê°€í•˜ì„¸ìš”</small></div>';
                }
            } catch (error) {
                console.error('íŒŒì¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                fileListContent.innerHTML = `<div style="padding: 15px; text-align: center; color: #E11D48;">
                    âŒ ë¡œë“œ ì‹¤íŒ¨<br>
                    <small>${error.message}</small><br>
                    <button onclick="loadFiles()" style="margin-top: 10px; padding: 5px 10px; cursor: pointer;">ë‹¤ì‹œ ì‹œë„</button>
                </div>`;
            }
        }

        // í´ë” ë° íŒŒì¼ ëª©ë¡ í‘œì‹œ
        function displayFoldersAndFiles(folders, files) {
            const fileListContent = document.getElementById('fileListContent');

            if (folders.length === 0 && files.length === 0) {
                fileListContent.innerHTML = '<div style="padding: 15px; text-align: center; color: #888;">ğŸ“ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            let html = '';

            // í´ë” ë¨¼ì € í‘œì‹œ (APIëŠ” {name, type, file_count, path} ê°ì²´ ë°˜í™˜)
            folders.forEach(folder => {
                const folderName = typeof folder === 'string' ? folder : folder.name;
                const folderPath = currentPath ? currentPath + '/' + folderName : folderName;
                const fileCount = folder.file_count || 0;
                html += `
                    <div class="folder-item" onclick="navigateTo('${folderPath}')">
                        <span class="folder-icon">ğŸ“</span>
                        <span class="folder-name">${folderName}${fileCount > 0 ? ' (' + fileCount + ')' : ''}</span>
                    </div>
                `;
            });

            // íŒŒì¼ í‘œì‹œ
            files.forEach(file => {
                // íŒŒì¼ ê²½ë¡œ ìƒì„± (outputs/í•˜ìœ„í´ë”/íŒŒì¼ëª… í˜•íƒœ)
                const filePath = currentPath ? 'outputs/' + currentPath + '/' + file.name : file.name;
                html += `
                    <div class="file-item" onclick="loadFile('${filePath}')">
                        <div class="file-name">${file.name}</div>
                        <div class="file-time">${file.time}</div>
                    </div>
                `;
            });

            fileListContent.innerHTML = html;
        }

        // íŒŒì¼ ëª©ë¡ í‘œì‹œ (í•˜ìœ„ í˜¸í™˜ìš©)
        function displayFileList(files) {
            displayFoldersAndFiles([], files);
        }

        // HTML íŒŒì¼ ì—…ë¡œë“œ ë‹¤ì´ì–¼ë¡œê·¸ ì—´ê¸°
        function openHtmlUpload() {
            document.getElementById('htmlFileInput').click();
        }

        // HTML íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        async function uploadHtmlFile(file) {
            if (!file) return;

            if (!file.name.endsWith('.html')) {
                showNotification('HTML íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'error');
                return;
            }

            try {
                showNotification('íŒŒì¼ ì—…ë¡œë“œ ì¤‘...', 'info');

                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/editor/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(`ì—…ë¡œë“œ ì™„ë£Œ: ${result.filename}`, 'success');
                    // íŒŒì¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    await loadFiles();
                    // ì—…ë¡œë“œí•œ íŒŒì¼ ìë™ìœ¼ë¡œ ì—´ê¸°
                    await loadFile(result.filename);
                } else {
                    showNotification(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${result.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
                }
            } catch (error) {
                console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                showNotification(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }

            // input ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡)
            document.getElementById('htmlFileInput').value = '';
        }

        // íŒŒì¼ ë¡œë“œ (í•˜ìœ„ í´ë” ê²½ë¡œ ì§€ì›)
        async function loadFile(filePath) {
            try {
                const timestamp = new Date().getTime();
                // filePathê°€ outputs/í•˜ìœ„í´ë”/íŒŒì¼ëª… í˜•íƒœë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©, ì•„ë‹ˆë©´ /outputs/ ë¶™ì„
                let fetchUrl;
                if (filePath.startsWith('outputs/') || filePath.startsWith('/outputs/')) {
                    fetchUrl = `/${filePath.replace(/^\//, '')}?t=${timestamp}`;
                } else {
                    fetchUrl = `/outputs/${filePath}?t=${timestamp}`;
                }

                const response = await fetch(fetchUrl, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                const content = await response.text();

                document.getElementById('htmlEditor').value = content;
                originalContent = content;
                currentFile = filePath;  // ì „ì²´ ê²½ë¡œ ì €ì¥

                // íŒŒì¼ëª…ë§Œ ì¶”ì¶œí•´ì„œ í‘œì‹œ
                const filename = filePath.split('/').pop();

                document.querySelectorAll('.file-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.querySelector('.file-name').textContent === filename) {
                        item.classList.add('active');
                    }
                });

                updateStatus(`${filename} ë¡œë“œë¨`);
                updateCharCount();
                updatePreview();  // ì¦‰ì‹œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            } catch (error) {
                console.error('íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:', error);
                showNotification('íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
            }
        }

        // íŒŒì¼ ì €ì¥
        async function saveFile() {
            if (!currentFile) {
                showNotification('ì €ì¥í•  íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }

            const content = document.getElementById('htmlEditor').value;

            try {
                const response = await fetch(`/api/editor/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filename: currentFile,
                        content: content
                    })
                });

                if (response.ok) {
                    originalContent = content;
                    showNotification('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                    updateStatus(`${currentFile} ì €ì¥ë¨`);
                } else {
                    throw new Error('ì €ì¥ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('ì €ì¥ ì‹¤íŒ¨:', error);
                showNotification('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        function downloadFile() {
            if (!currentFile) {
                showNotification('ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }

            let content = document.getElementById('htmlEditor').value;

            // ì´ë¯¸ì§€ ê²½ë¡œë¥¼ ìƒëŒ€ ê²½ë¡œë¡œ ë³€í™˜ (ë¡œì»¬ì—ì„œ ì‘ë™í•˜ë„ë¡)
            // /outputs/xxx.png â†’ ./xxx.png
            content = content.replace(/(['"])\/?outputs\//g, '$1./');
            // /static/xxx â†’ ./xxx
            content = content.replace(/(['"])\/?static\//g, '$1./');

            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFile;
            a.click();
            URL.revokeObjectURL(url);

            showNotification('ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤ (ì´ë¯¸ì§€ëŠ” ê°™ì€ í´ë”ì— ì €ì¥í•˜ì„¸ìš”)', 'success');
        }

        // ZIP ë‹¤ìš´ë¡œë“œ (HTML + ì´ë¯¸ì§€ í•¨ê»˜)
        async function downloadWithImages() {
            if (!currentFile) {
                showNotification('ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }

            showNotification('ZIP íŒŒì¼ ìƒì„± ì¤‘...', 'success');

            try {
                const zip = new JSZip();
                let content = document.getElementById('htmlEditor').value;

                // HTMLì—ì„œ ì´ë¯¸ì§€ ê²½ë¡œ ì¶”ì¶œ
                const imageRegex = /(['"])\/?(outputs|static)\/([^'"]+\.(?:png|jpg|jpeg|gif|webp))\1/gi;
                const matches = [...content.matchAll(imageRegex)];
                const imagePaths = new Set();

                for (const match of matches) {
                    const folder = match[2];
                    const filename = match[3];
                    imagePaths.add({ folder, filename, fullPath: `/${folder}/${filename}` });
                }

                // ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ë° ZIPì— ì¶”ê°€
                for (const img of imagePaths) {
                    try {
                        const response = await fetch(img.fullPath);
                        if (response.ok) {
                            const blob = await response.blob();
                            zip.file(img.filename, blob);
                            // HTMLì—ì„œ ê²½ë¡œë¥¼ ìƒëŒ€ ê²½ë¡œë¡œ ë³€ê²½
                            content = content.split(img.fullPath).join('./' + img.filename);
                        }
                    } catch (e) {
                        console.warn(`ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${img.fullPath}`);
                    }
                }

                // ì¶”ê°€ë¡œ /outputs/ ë˜ëŠ” /static/ ê²½ë¡œ ë³€í™˜
                content = content.replace(/(['"])\/?outputs\//g, '$1./');
                content = content.replace(/(['"])\/?static\//g, '$1./');

                // HTML íŒŒì¼ ì¶”ê°€
                zip.file(currentFile, content);

                // ZIP ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = currentFile.replace('.html', '_package.zip');
                a.click();
                URL.revokeObjectURL(url);

                showNotification(`ZIP ë‹¤ìš´ë¡œë“œ ì™„ë£Œ (ì´ë¯¸ì§€ ${imagePaths.size}ê°œ í¬í•¨)`, 'success');
            } catch (e) {
                console.error(e);
                showNotification('ZIP ìƒì„± ì‹¤íŒ¨: ' + e.message, 'error');
            }
        }

        // ì¢Œìš° íŒ¨ë„ ì „í™˜ (ì™¼ì†ì¡ì´/ì˜¤ë¥¸ì†ì¡ì´ ì§€ì›)
        function swapPanels() {
            const container = document.getElementById('splitContainer');
            const editorPanel = document.getElementById('editorPanel');
            const previewPanel = document.getElementById('previewPanel');
            const resizer = document.getElementById('resizer');

            if (isEditorOnLeft) {
                // ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì™¼ìª½ìœ¼ë¡œ
                container.insertBefore(previewPanel, editorPanel);
                container.insertBefore(resizer, editorPanel);
                showNotification('ë¯¸ë¦¬ë³´ê¸°ê°€ ì™¼ìª½ìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤', 'success');
            } else {
                // í¸ì§‘ê¸°ë¥¼ ì™¼ìª½ìœ¼ë¡œ
                container.insertBefore(editorPanel, previewPanel);
                container.insertBefore(resizer, previewPanel);
                showNotification('í¸ì§‘ê¸°ê°€ ì™¼ìª½ìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤', 'success');
            }
            isEditorOnLeft = !isEditorOnLeft;

            // ì„¤ì • ì €ì¥
            localStorage.setItem('editorOnLeft', isEditorOnLeft);
        }

        // ë¯¸ë¦¬ë³´ê¸° í¬ê¸° ì„¤ì • (ë°ìŠ¤í¬í†±/íƒœë¸”ë¦¿/ëª¨ë°”ì¼)
        function setPreviewSize(size) {
            const device = document.getElementById('previewDevice');
            device.className = 'preview-device ' + size;

            document.querySelectorAll('.preview-size-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„ ë™ê¸°í™”)
        function updatePreview() {
            let content = document.getElementById('htmlEditor').value;

            // í˜„ì¬ íŒŒì¼ ê²½ë¡œì—ì„œ ê¸°ë³¸ ê²½ë¡œ ì¶”ì¶œ (ì˜ˆ: outputs/Minjoo/RYU.html -> /outputs/Minjoo/)
            if (currentFile) {
                const pathParts = currentFile.split('/');
                pathParts.pop(); // íŒŒì¼ëª… ì œê±°
                const basePath = '/' + pathParts.join('/') + '/';

                // ìƒëŒ€ ê²½ë¡œ ì´ë¯¸ì§€ë¥¼ ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜
                // ./images/xxx.png -> /outputs/Minjoo/images/xxx.png
                content = content.replace(/src=["']\.\/([^"']+)["']/g, `src="${basePath}$1"`);
                // ./xxx.png -> /outputs/Minjoo/xxx.png
                content = content.replace(/src=["'](?!http|\/|data:)([^"']+)["']/g, `src="${basePath}$1"`);
            }

            const iframe = document.getElementById('previewFrame');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(content);
            iframeDoc.close();

            // ë™ê¸°í™” í‘œì‹œ ì—…ë°ì´íŠ¸
            const syncIndicator = document.getElementById('syncIndicator');
            syncIndicator.textContent = 'â— ë™ê¸°í™”ë¨';
            syncIndicator.classList.remove('syncing');
        }

        // ë””ë°”ìš´ìŠ¤ëœ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ (íƒ€ì´í•‘ ì¤‘ ì„±ëŠ¥ ìµœì í™”)
        function schedulePreviewUpdate() {
            const syncIndicator = document.getElementById('syncIndicator');
            syncIndicator.textContent = 'â—Œ ë™ê¸°í™” ì¤‘...';
            syncIndicator.classList.add('syncing');

            if (previewUpdateTimer) {
                clearTimeout(previewUpdateTimer);
            }
            previewUpdateTimer = setTimeout(() => {
                updatePreview();
            }, 300);  // 300ms ë””ë°”ìš´ìŠ¤
        }


        // í…ìŠ¤íŠ¸ ì„œì‹ ì ìš© (êµµê²Œ, ê¸°ìš¸ì„, ë°‘ì¤„)
        function formatText(format) {
            const editor = document.getElementById('htmlEditor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const selectedText = editor.value.substring(start, end);
            
            if (!selectedText) {
                showNotification('í…ìŠ¤íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
                return;
            }
            
            let formattedText = '';
            switch(format) {
                case 'bold':
                    formattedText = '<strong>' + selectedText + '</strong>';
                    break;
                case 'italic':
                    formattedText = '<em>' + selectedText + '</em>';
                    break;
                case 'underline':
                    formattedText = '<u>' + selectedText + '</u>';
                    break;
                default:
                    formattedText = selectedText;
            }
            
            editor.value = editor.value.substring(0, start) + formattedText + editor.value.substring(end);
            editor.selectionStart = start;
            editor.selectionEnd = start + formattedText.length;
            editor.focus();
            
            updatePreview();
            markAsModified();
            showNotification(format + ' ì„œì‹ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }
        
        // HTML ìš”ì†Œ ì‚½ì… (ì œëª©1, ì œëª©2, ë³¸ë¬¸)
        function insertElement(element) {
            const editor = document.getElementById('htmlEditor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const selectedText = editor.value.substring(start, end) || 'í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”';
            
            let html = '';
            switch(element) {
                case 'h1':
                    html = '<h1>' + selectedText + '</h1>';
                    break;
                case 'h2':
                    html = '<h2>' + selectedText + '</h2>';
                    break;
                case 'p':
                    html = '<p>' + selectedText + '</p>';
                    break;
                default:
                    html = selectedText;
            }
            
            editor.value = editor.value.substring(0, start) + html + editor.value.substring(end);
            editor.selectionStart = start;
            editor.selectionEnd = start + html.length;
            editor.focus();
            
            updatePreview();
            markAsModified();
            showNotification(element + ' ìš”ì†Œê°€ ì‚½ì…ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }
        
        // ìˆ˜ì •ë¨ í‘œì‹œ
        function markAsModified() {
            if (currentFile && !document.title.startsWith('* ')) {
                updateStatus(currentFile + ' (ìˆ˜ì •ë¨)');
            }
        }

        // HTML ì •ë¦¬
        function beautifyHTML() {
            const content = document.getElementById('htmlEditor').value;
            let beautified = content
                .replace(/>\s+</g, '>\n<')
                .replace(/\n\s*\n/g, '\n');

            document.getElementById('htmlEditor').value = beautified;
            showNotification('HTMLì´ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            updatePreview();
        }

        // ì°¾ê¸°/ë°”ê¾¸ê¸°
        function findReplace() {
            const find = prompt('ì°¾ì„ í…ìŠ¤íŠ¸:');
            if (!find) return;

            const replace = prompt('ë°”ê¿€ í…ìŠ¤íŠ¸:');
            if (replace === null) return;

            const content = document.getElementById('htmlEditor').value;
            const newContent = content.replaceAll(find, replace);
            document.getElementById('htmlEditor').value = newContent;

            const count = (content.match(new RegExp(find, 'g')) || []).length;
            showNotification(`${count}ê°œ í•­ëª©ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
            updatePreview();
        }

        // ì•Œë¦¼ í‘œì‹œ
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStatus(text) {
            document.getElementById('statusText').textContent = text;
        }

        // ê¸€ì ìˆ˜ ì—…ë°ì´íŠ¸
        function updateCharCount() {
            const content = document.getElementById('htmlEditor').value;
            document.getElementById('charCount').textContent = `${content.length.toLocaleString()} ì`;
        }

        // ë¦¬ì‚¬ì´ì € ë“œë˜ê·¸ ê¸°ëŠ¥
        function initResizer() {
            const resizer = document.getElementById('resizer');
            const editorPanel = document.getElementById('editorPanel');
            const previewPanel = document.getElementById('previewPanel');
            const container = document.getElementById('splitContainer');

            let isResizing = false;

            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const containerRect = container.getBoundingClientRect();
                const fileListWidth = document.getElementById('fileList').offsetWidth;
                const mouseX = e.clientX - containerRect.left;
                const containerWidth = containerRect.width;

                // ìµœì†Œ/ìµœëŒ€ í¬ê¸° ì œí•œ
                const minWidth = 300;
                const maxWidth = containerWidth - minWidth - 6;

                let leftPanelWidth = Math.max(minWidth, Math.min(mouseX, maxWidth));

                if (isEditorOnLeft) {
                    editorPanel.style.flex = 'none';
                    editorPanel.style.width = leftPanelWidth + 'px';
                    previewPanel.style.flex = '1';
                    previewPanel.style.width = 'auto';
                } else {
                    previewPanel.style.flex = 'none';
                    previewPanel.style.width = leftPanelWidth + 'px';
                    editorPanel.style.flex = '1';
                    editorPanel.style.width = 'auto';
                }
            });

            document.addEventListener('mouseup', () => {
                isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            });
        }

        // ì €ì¥ëœ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        function loadSettings() {
            const savedPosition = localStorage.getItem('editorOnLeft');
            if (savedPosition !== null && savedPosition === 'false') {
                swapPanels();
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('htmlEditor').addEventListener('input', () => {
            updateCharCount();
            schedulePreviewUpdate();  // ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° ë™ê¸°í™”
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            loadFiles();
            initResizer();
            loadSettings();

            // URL íŒŒë¼ë¯¸í„°ì—ì„œ íŒŒì¼ ê²½ë¡œ í™•ì¸
            const urlParams = new URLSearchParams(window.location.search);
            const fileParam = urlParams.get('file');
            if (fileParam) {
                // íŒŒì¼ ê²½ë¡œê°€ ì „ë‹¬ë˜ë©´ ìë™ìœ¼ë¡œ ë¡œë“œ
                console.log('URL íŒŒë¼ë¯¸í„°ë¡œ íŒŒì¼ ë¡œë“œ:', fileParam);
                loadFile(fileParam);
            }
        });

        // ë‹¨ì¶•í‚¤
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveFile();
            }
            if (e.key === 'F3') {
                e.preventDefault();
                findNext();
            }
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                findReplace();
            }
        });

        // ==========================================
        // ì—°ë™ ëª¨ë“œ (ì—ë””í„° â†” ë¯¸ë¦¬ë³´ê¸° í•˜ì´ë¼ì´íŠ¸)
        // ==========================================

        // ì—°ë™ ëª¨ë“œ í† ê¸€
        function toggleSyncMode() {
            isSyncModeActive = !isSyncModeActive;
            const btn = document.getElementById('syncModeBtn');

            if (isSyncModeActive) {
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-success');
                btn.textContent = 'ğŸ”— ì—°ë™ëª¨ë“œ ON';
                showNotification('ì—°ë™ ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ì—°ê´€ ìœ„ì¹˜ê°€ í•˜ì´ë¼ì´íŠ¸ë©ë‹ˆë‹¤.', 'success');
                initSyncMode();
            } else {
                btn.classList.remove('btn-success');
                btn.classList.add('btn-secondary');
                btn.textContent = 'ğŸ”— ì—°ë™ëª¨ë“œ';
                showNotification('ì—°ë™ ëª¨ë“œê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                cleanupSyncMode();
            }
        }

        // ì—°ë™ ëª¨ë“œ ì´ˆê¸°í™”
        function initSyncMode() {
            const editor = document.getElementById('htmlEditor');
            const iframe = document.getElementById('previewFrame');

            // ì—ë””í„°ì—ì„œ ë§ˆìš°ìŠ¤ ì´ë™ ê°ì§€
            editor.addEventListener('mousemove', onEditorMouseMove);
            editor.addEventListener('mouseleave', onEditorMouseLeave);

            // ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ë§ˆìš°ìŠ¤ ì´ë™ ê°ì§€
            iframe.addEventListener('load', () => {
                if (isSyncModeActive) {
                    setupPreviewListeners();
                }
            });

            // í˜„ì¬ ë¡œë“œëœ ë¯¸ë¦¬ë³´ê¸°ì—ë„ ì ìš©
            setupPreviewListeners();
        }

        // ì—°ë™ ëª¨ë“œ ì •ë¦¬
        function cleanupSyncMode() {
            const editor = document.getElementById('htmlEditor');
            editor.removeEventListener('mousemove', onEditorMouseMove);
            editor.removeEventListener('mouseleave', onEditorMouseLeave);

            // í•˜ì´ë¼ì´íŠ¸ ì œê±°
            clearAllHighlights();
            hideTooltip();
        }

        // ë¯¸ë¦¬ë³´ê¸° iframeì— ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupPreviewListeners() {
            const iframe = document.getElementById('previewFrame');
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                // ë¯¸ë¦¬ë³´ê¸° ë‚´ ìš”ì†Œì— ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ì¶”ê°€
                iframeDoc.body.addEventListener('mouseover', onPreviewMouseOver);
                iframeDoc.body.addEventListener('mouseout', onPreviewMouseOut);

                // í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ ì£¼ì…
                injectHighlightStyles(iframeDoc);
            } catch (e) {
                console.log('ë¯¸ë¦¬ë³´ê¸° ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹¤íŒ¨:', e);
            }
        }

        // ë¯¸ë¦¬ë³´ê¸°ì— í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ ì£¼ì…
        function injectHighlightStyles(doc) {
            if (doc.getElementById('syncHighlightStyles')) return;

            const style = doc.createElement('style');
            style.id = 'syncHighlightStyles';
            style.textContent = `
                .sync-highlight {
                    outline: 3px solid #FBBF24 !important;
                    outline-offset: 2px !important;
                    background-color: rgba(251, 191, 36, 0.2) !important;
                    transition: all 0.15s ease !important;
                }
                .sync-highlight * {
                    background-color: rgba(251, 191, 36, 0.1) !important;
                }
            `;
            doc.head.appendChild(style);
        }

        // ì—ë””í„°ì—ì„œ ë§ˆìš°ìŠ¤ ì´ë™ ì‹œ
        function onEditorMouseMove(e) {
            if (!isSyncModeActive) return;

            const editor = e.target;
            const content = editor.value;

            // ì»¤ì„œ ìœ„ì¹˜ ê³„ì‚°
            const cursorPos = editor.selectionStart;

            // í˜„ì¬ ì¤„ ì°¾ê¸°
            const textBeforeCursor = content.substring(0, cursorPos);
            const currentLine = textBeforeCursor.split('\n').length;

            // í˜„ì¬ ì¤„ì˜ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
            const lines = content.split('\n');
            const lineContent = lines[currentLine - 1] || '';

            // HTML íƒœê·¸ ì°¾ê¸°
            const tagMatch = lineContent.match(/<(\w+)[^>]*(?:class="([^"]*)")?[^>]*>/);

            if (tagMatch) {
                const tagName = tagMatch[1];
                const className = tagMatch[2];

                // ë¯¸ë¦¬ë³´ê¸°ì—ì„œ í•´ë‹¹ ìš”ì†Œ ì°¾ì•„ì„œ í•˜ì´ë¼ì´íŠ¸
                highlightInPreview(tagName, className, lineContent, currentLine);

                // íˆ´íŒ í‘œì‹œ
                showTooltip(e.clientX, e.clientY - 30, `${tagName}${className ? '.' + className.split(' ')[0] : ''} (ì¤„ ${currentLine})`);
            } else {
                clearPreviewHighlight();
                hideTooltip();
            }
        }

        // ì—ë””í„°ì—ì„œ ë§ˆìš°ìŠ¤ê°€ ë‚˜ê°ˆ ë•Œ
        function onEditorMouseLeave() {
            clearPreviewHighlight();
            hideTooltip();
        }

        // ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ
        function onPreviewMouseOver(e) {
            if (!isSyncModeActive) return;

            const element = e.target;
            if (element.tagName === 'HTML' || element.tagName === 'BODY') return;

            // ìš”ì†Œ í•˜ì´ë¼ì´íŠ¸
            element.classList.add('sync-highlight');
            lastHighlightedElement = element;

            // ì—ë””í„°ì—ì„œ í•´ë‹¹ ìš”ì†Œ ì°¾ê¸°
            highlightInEditor(element);

            // íˆ´íŒ í‘œì‹œ (iframe ë‚´ ì¢Œí‘œë¥¼ í˜ì´ì§€ ì¢Œí‘œë¡œ ë³€í™˜)
            const iframe = document.getElementById('previewFrame');
            const iframeRect = iframe.getBoundingClientRect();
            const tagInfo = getElementInfo(element);
            showTooltip(e.clientX + iframeRect.left, e.clientY + iframeRect.top - 30, tagInfo);
        }

        // ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ë§ˆìš°ìŠ¤ ì•„ì›ƒ ì‹œ
        function onPreviewMouseOut(e) {
            if (!isSyncModeActive) return;

            const element = e.target;
            element.classList.remove('sync-highlight');

            clearEditorHighlight();
            hideTooltip();
        }

        // ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ìš”ì†Œ í•˜ì´ë¼ì´íŠ¸
        function highlightInPreview(tagName, className, lineContent, lineNum) {
            const iframe = document.getElementById('previewFrame');
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                // ì´ì „ í•˜ì´ë¼ì´íŠ¸ ì œê±°
                clearPreviewHighlight();

                // ìš”ì†Œ ì°¾ê¸°
                let elements;
                if (className) {
                    elements = iframeDoc.querySelectorAll(`${tagName}.${className.split(' ')[0]}`);
                } else {
                    elements = iframeDoc.querySelectorAll(tagName);
                }

                // í…ìŠ¤íŠ¸ ë‚´ìš©ìœ¼ë¡œ ë” ì •í™•í•˜ê²Œ ì°¾ê¸°
                const textMatch = lineContent.match(/>([^<]+)</);
                const searchText = textMatch ? textMatch[1].trim() : '';

                if (elements.length > 0) {
                    let targetElement = elements[0];

                    // í…ìŠ¤íŠ¸ë¡œ ë” ì •í™•í•œ ìš”ì†Œ ì°¾ê¸°
                    if (searchText) {
                        for (let el of elements) {
                            if (el.textContent.includes(searchText)) {
                                targetElement = el;
                                break;
                            }
                        }
                    }

                    targetElement.classList.add('sync-highlight');
                    lastHighlightedElement = targetElement;

                    // ìŠ¤í¬ë¡¤í•´ì„œ ë³´ì´ê²Œ
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            } catch (e) {
                console.log('ë¯¸ë¦¬ë³´ê¸° í•˜ì´ë¼ì´íŠ¸ ì‹¤íŒ¨:', e);
            }
        }

        // ì—ë””í„°ì—ì„œ í•´ë‹¹ ìš”ì†Œ ìœ„ì¹˜ í•˜ì´ë¼ì´íŠ¸ - ê°œì„ ëœ ë²„ì „ v2
        function highlightInEditor(element) {
            const editor = document.getElementById('htmlEditor');
            const editorContent = editor.value;

            // ìš”ì†Œì˜ íƒœê·¸ëª…, í´ë˜ìŠ¤, í…ìŠ¤íŠ¸ ì •ë³´ ìˆ˜ì§‘
            const tagName = element.tagName.toLowerCase();
            const className = (element.className || '').toString().replace(/sync-highlight|element-selected|element-moveable/g, '').trim();
            const firstClass = className.split(' ')[0];
            const elementId = element.id;

            // ìš”ì†Œì˜ DOM ì¸ë±ìŠ¤ ê³„ì‚° (ê°™ì€ í´ë˜ìŠ¤ë¥¼ ê°€ì§„ ìš”ì†Œë“¤ ì¤‘ ëª‡ ë²ˆì§¸ì¸ì§€)
            let elementIndex = 0;
            if (firstClass) {
                const iframe = document.getElementById('previewFrame');
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                const sameClassElements = iframeDoc.querySelectorAll('.' + firstClass);
                for (let i = 0; i < sameClassElements.length; i++) {
                    if (sameClassElements[i] === element) {
                        elementIndex = i;
                        break;
                    }
                }
            }

            // ì§ì ‘ì ì¸ í…ìŠ¤íŠ¸ ë‚´ìš© ì¶”ì¶œ (ìì‹ ìš”ì†Œì˜ í…ìŠ¤íŠ¸ ì œì™¸)
            let directText = '';
            for (let node of element.childNodes) {
                if (node.nodeType === Node.TEXT_NODE) {
                    directText += node.textContent.trim();
                }
            }

            // íŠ¹ë³„ ì²˜ë¦¬: h4 íƒœê·¸ ë‚´ì˜ "í˜ì´ì§€" í…ìŠ¤íŠ¸ (ì „ë¬¸ë³´ê¸° ì„¹ì…˜)
            if (tagName === 'h4' && element.textContent.includes('í˜ì´ì§€')) {
                directText = element.textContent.trim();
            }

            // ì§ì ‘ í…ìŠ¤íŠ¸ê°€ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ì¤„ì˜ í…ìŠ¤íŠ¸ ì‚¬ìš©
            if (!directText) {
                directText = element.textContent.trim().split('\n')[0].substring(0, 80);
            }

            let foundPos = -1;

            // 1. IDê°€ ìˆìœ¼ë©´ IDë¡œ ì •í™•íˆ ê²€ìƒ‰
            if (foundPos === -1 && elementId) {
                const idPattern = new RegExp('id=["\']' + elementId.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '["\']', 'i');
                const idMatch = idPattern.exec(editorContent);
                if (idMatch) {
                    foundPos = editorContent.lastIndexOf('<', idMatch.index);
                }
            }

            // 2. êµ¬ì²´ì ì¸ í…ìŠ¤íŠ¸ë¡œ ê²€ìƒ‰ (í´ë˜ìŠ¤ì™€ í•¨ê»˜ ì‚¬ìš©)
            if (foundPos === -1 && directText && directText.length >= 3) {
                // í´ë˜ìŠ¤ê°€ ìˆëŠ” ê²½ìš°, í•´ë‹¹ í´ë˜ìŠ¤ ë¸”ë¡ ë‚´ì—ì„œ í…ìŠ¤íŠ¸ ì°¾ê¸°
                if (firstClass) {
                    const escapedClass = firstClass.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const classPattern = new RegExp('class="[^"]*' + escapedClass + '[^"]*"', 'gi');
                    let match;
                    let matchCount = 0;
                    while ((match = classPattern.exec(editorContent)) !== null) {
                        if (matchCount === elementIndex) {
                            foundPos = editorContent.lastIndexOf('<', match.index);
                            break;
                        }
                        matchCount++;
                    }
                }

                // í´ë˜ìŠ¤ë¡œ ëª» ì°¾ì€ ê²½ìš° í…ìŠ¤íŠ¸ë¡œ ì§ì ‘ ê²€ìƒ‰
                if (foundPos === -1) {
                    // íŠ¹ìˆ˜ ë¬¸ì ì´ìŠ¤ì¼€ì´í”„
                    const searchText = directText.substring(0, 50);
                    let searchIdx = editorContent.indexOf(searchText);
                    if (searchIdx !== -1) {
                        let tagStart = editorContent.lastIndexOf('<', searchIdx);
                        if (tagStart !== -1 && tagStart < searchIdx) {
                            foundPos = tagStart;
                        } else {
                            foundPos = searchIdx;
                        }
                    }
                }
            }

            // 3. í´ë˜ìŠ¤ë¡œ ê²€ìƒ‰ (në²ˆì§¸ ë§¤ì¹­)
            if (foundPos === -1 && firstClass) {
                const escapedClass = firstClass.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const classPattern = new RegExp('class="[^"]*' + escapedClass + '[^"]*"', 'gi');
                let match;
                let matchCount = 0;
                while ((match = classPattern.exec(editorContent)) !== null) {
                    if (matchCount === elementIndex) {
                        foundPos = editorContent.lastIndexOf('<', match.index);
                        break;
                    }
                    matchCount++;
                }
            }

            // 4. íƒœê·¸ëª…ìœ¼ë¡œ ê²€ìƒ‰ (ë§ˆì§€ë§‰ ìˆ˜ë‹¨)
            if (foundPos === -1) {
                const tagPattern = new RegExp('<' + tagName + '[^>]*>', 'i');
                const tagMatch = tagPattern.exec(editorContent);
                if (tagMatch) {
                    foundPos = tagMatch.index;
                }
            }

            // ì°¾ì€ ìœ„ì¹˜ë¡œ ì´ë™
            if (foundPos !== -1) {
                // í•´ë‹¹ íƒœê·¸ì˜ ì „ì²´ ì„ íƒ (ì—¬ëŠ” íƒœê·¸ + ë‚´ìš© + ë‹«ëŠ” íƒœê·¸)
                let endPos = editorContent.indexOf('>', foundPos);
                if (endPos === -1) endPos = foundPos + 50;
                else endPos += 1;

                // ë‹«ëŠ” íƒœê·¸ê¹Œì§€ ì°¾ê¸° (ë‚´ìš©ì´ ì§§ì€ ê²½ìš°ì—ë§Œ)
                const closeTagPattern = new RegExp('</' + tagName + '>', 'i');
                const contentAfterOpen = editorContent.substring(endPos);
                const closeMatch = closeTagPattern.exec(contentAfterOpen);
                if (closeMatch && closeMatch.index < 500) {  // 500ì ì´ë‚´ë©´ ì „ì²´ ì„ íƒ
                    endPos = endPos + closeMatch.index + closeMatch[0].length;
                }

                // í•´ë‹¹ ì¤„ ë²ˆí˜¸ ê³„ì‚°
                const textBefore = editorContent.substring(0, foundPos);
                const lineNum = textBefore.split('\n').length;

                // ì—ë””í„° ìŠ¤í¬ë¡¤
                const lineHeight = 18;
                editor.scrollTop = Math.max(0, (lineNum - 5) * lineHeight);

                // ì„ íƒ í‘œì‹œ
                editor.setSelectionRange(foundPos, endPos);
                editor.focus();

                // í˜„ì¬ ì„ íƒëœ ìš”ì†Œ ì •ë³´ ì €ì¥ (ì´ë™ ê¸°ëŠ¥ìš©)
                lastFoundPosition = { start: foundPos, end: endPos, element: element };
            }
        }

        // ë§ˆì§€ë§‰ ì°¾ì€ ìœ„ì¹˜ ì €ì¥ (ì´ë™ ê¸°ëŠ¥ìš©)
        let lastFoundPosition = null;

        // ë¯¸ë¦¬ë³´ê¸° í•˜ì´ë¼ì´íŠ¸ ì œê±°
        function clearPreviewHighlight() {
            if (lastHighlightedElement) {
                lastHighlightedElement.classList.remove('sync-highlight');
                lastHighlightedElement = null;
            }

            const iframe = document.getElementById('previewFrame');
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                iframeDoc.querySelectorAll('.sync-highlight').forEach(el => {
                    el.classList.remove('sync-highlight');
                });
            } catch (e) {}
        }

        // ì—ë””í„° í•˜ì´ë¼ì´íŠ¸ ì œê±°
        function clearEditorHighlight() {
            // ì„ íƒ í•´ì œ
            const editor = document.getElementById('htmlEditor');
            const pos = editor.selectionStart;
            editor.setSelectionRange(pos, pos);
        }

        // ëª¨ë“  í•˜ì´ë¼ì´íŠ¸ ì œê±°
        function clearAllHighlights() {
            clearPreviewHighlight();
            clearEditorHighlight();
        }

        // ìš”ì†Œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        function getElementInfo(element) {
            const tag = element.tagName.toLowerCase();
            const id = element.id ? `#${element.id}` : '';
            const className = element.className.replace('sync-highlight', '').trim();
            const classStr = className ? `.${className.split(' ')[0]}` : '';
            return `<${tag}${id}${classStr}>`;
        }

        // íˆ´íŒ í‘œì‹œ
        function showTooltip(x, y, text) {
            const tooltip = document.getElementById('highlightTooltip');
            tooltip.textContent = text;
            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
            tooltip.style.display = 'block';
        }

        // íˆ´íŒ ìˆ¨ê¸°ê¸°
        function hideTooltip() {
            const tooltip = document.getElementById('highlightTooltip');
            tooltip.style.display = 'none';
        }

        // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ í›„ ì—°ë™ ëª¨ë“œ ë¦¬ìŠ¤ë„ˆ ì¬ì„¤ì •
        const originalUpdatePreview = updatePreview;
        updatePreview = function() {
            originalUpdatePreview();
            if (isSyncModeActive) {
                setTimeout(setupPreviewListeners, 100);
                setTimeout(setupElementSelection, 150);
            }
        };

        // ==========================================
        // ìš”ì†Œ ì„ íƒ ë° ì´ë™ ê¸°ëŠ¥
        // ==========================================

        let selectedElement = null;
        let selectedElementHTML = '';

        // ìš”ì†Œ ì„ íƒ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupElementSelection() {
            const iframe = document.getElementById('previewFrame');
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                // ì´ì „ ë¦¬ìŠ¤ë„ˆ ì œê±°
                iframeDoc.body.removeEventListener('click', onPreviewClick);
                iframeDoc.removeEventListener('keydown', onPreviewKeydown);

                // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                iframeDoc.body.addEventListener('click', onPreviewClick);
                iframeDoc.addEventListener('keydown', onPreviewKeydown);

                // ì„ íƒ ëª¨ë“œ ìŠ¤íƒ€ì¼ ì£¼ì…
                injectSelectionStyles(iframeDoc);
            } catch (e) {
                console.log('ìš”ì†Œ ì„ íƒ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹¤íŒ¨:', e);
            }
        }

        // ì„ íƒ ëª¨ë“œ ìŠ¤íƒ€ì¼ ì£¼ì…
        function injectSelectionStyles(doc) {
            if (doc.getElementById('selectionStyles')) return;

            const style = doc.createElement('style');
            style.id = 'selectionStyles';
            style.textContent = `
                .element-selected {
                    outline: 3px solid #3B82F6 !important;
                    outline-offset: 2px !important;
                    background-color: rgba(59, 130, 246, 0.1) !important;
                    cursor: move !important;
                }
                .element-moveable:hover {
                    outline: 2px dashed #9CA3AF !important;
                    outline-offset: 1px !important;
                }
            `;
            doc.head.appendChild(style);
        }

        // ë¯¸ë¦¬ë³´ê¸°ì—ì„œ í´ë¦­ ì‹œ
        function onPreviewClick(e) {
            if (!isSyncModeActive) return;

            e.preventDefault();
            e.stopPropagation();

            const element = e.target;
            if (element.tagName === 'HTML' || element.tagName === 'BODY') {
                deselectElement();
                return;
            }

            selectElement(element);
        }

        // ìš”ì†Œ ì„ íƒ
        function selectElement(element) {
            // ì´ì „ ì„ íƒ í•´ì œ
            deselectElement(false);

            // ìƒˆ ìš”ì†Œ ì„ íƒ
            selectedElement = element;
            element.classList.add('element-selected');

            // ì—ë””í„°ì—ì„œ í•´ë‹¹ ìœ„ì¹˜ ì°¾ê¸°
            highlightInEditor(element);

            // ì´ë™ ì»¨íŠ¸ë¡¤ íŒ¨ë„ í‘œì‹œ
            showMoveControls(element);
        }

        // ìš”ì†Œ ì„ íƒ í•´ì œ
        function deselectElement(hideControls = true) {
            if (selectedElement) {
                selectedElement.classList.remove('element-selected');
                selectedElement = null;
            }

            // ëª¨ë“  ì„ íƒ í´ë˜ìŠ¤ ì œê±°
            const iframe = document.getElementById('previewFrame');
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                iframeDoc.querySelectorAll('.element-selected').forEach(el => {
                    el.classList.remove('element-selected');
                });
            } catch (e) {}

            if (hideControls) {
                hideMoveControls();
            }

            lastFoundPosition = null;
        }

        // ì´ë™ ì»¨íŠ¸ë¡¤ íŒ¨ë„ í‘œì‹œ
        function showMoveControls(element) {
            const controls = document.getElementById('moveControls');
            const info = document.getElementById('selectedElementInfo');

            // ìš”ì†Œ ì •ë³´ í‘œì‹œ
            const tag = element.tagName.toLowerCase();
            const classes = (element.className || '').toString().replace(/element-selected|sync-highlight/g, '').trim();
            const text = element.textContent.trim().substring(0, 30);
            info.innerHTML = `<b>&lt;${tag}&gt;</b>${classes ? '<br>.' + classes.split(' ')[0] : ''}<br><small>${text}${text.length >= 30 ? '...' : ''}</small>`;

            controls.classList.add('active');
        }

        // ì´ë™ ì»¨íŠ¸ë¡¤ íŒ¨ë„ ìˆ¨ê¸°ê¸°
        function hideMoveControls() {
            const controls = document.getElementById('moveControls');
            controls.classList.remove('active');
        }

        // ìš”ì†Œ ì´ë™
        function moveElement(direction) {
            if (!selectedElement || !lastFoundPosition) {
                showNotification('ë¨¼ì € ìš”ì†Œë¥¼ ì„ íƒí•˜ì„¸ìš”.', 'error');
                return;
            }

            const editor = document.getElementById('htmlEditor');
            let content = editor.value;
            const { start, end } = lastFoundPosition;

            // ì„ íƒëœ HTML ë¸”ë¡ ì¶”ì¶œ
            const selectedHTML = content.substring(start, end);

            switch (direction) {
                case 'up':
                    // ì´ì „ í˜•ì œ ìš”ì†Œì™€ ìœ„ì¹˜ êµí™˜
                    moveUp(content, selectedHTML, start, end);
                    break;
                case 'down':
                    // ë‹¤ìŒ í˜•ì œ ìš”ì†Œì™€ ìœ„ì¹˜ êµí™˜
                    moveDown(content, selectedHTML, start, end);
                    break;
                case 'left':
                    // ë¶€ëª¨ ìš”ì†Œ ë°–ìœ¼ë¡œ ì´ë™ (ì´ì „ ìœ„ì¹˜ë¡œ)
                    showNotification('ì™¼ìª½ ì´ë™: ë“¤ì—¬ì“°ê¸° ê°ì†Œ (ë¯¸êµ¬í˜„)', 'success');
                    break;
                case 'right':
                    // ì´ì „ í˜•ì œ ìš”ì†Œ ì•ˆìœ¼ë¡œ ì´ë™
                    showNotification('ì˜¤ë¥¸ìª½ ì´ë™: ë“¤ì—¬ì“°ê¸° ì¦ê°€ (ë¯¸êµ¬í˜„)', 'success');
                    break;
            }
        }

        // ìœ„ë¡œ ì´ë™
        function moveUp(content, selectedHTML, start, end) {
            // ì´ì „ í˜•ì œ ìš”ì†Œ ì°¾ê¸° (ì´ì „ ë‹«ëŠ” íƒœê·¸ ì°¾ê¸°)
            const beforeContent = content.substring(0, start);
            const prevCloseMatch = beforeContent.match(/<\/[^>]+>\s*$/);

            if (!prevCloseMatch) {
                showNotification('ë” ì´ìƒ ìœ„ë¡œ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            // ì´ì „ ìš”ì†Œì˜ ì‹œì‘ ìœ„ì¹˜ ì°¾ê¸°
            const prevCloseEnd = start;
            const prevCloseStart = start - prevCloseMatch[0].length;

            // ì´ì „ ìš”ì†Œì˜ ì—¬ëŠ” íƒœê·¸ ì°¾ê¸°
            const tagName = prevCloseMatch[0].match(/<\/(\w+)/)[1];
            const searchArea = content.substring(0, prevCloseStart);

            // ë§ˆì§€ë§‰ìœ¼ë¡œ ë‚˜ì˜¨ í•´ë‹¹ íƒœê·¸ì˜ ì—¬ëŠ” íƒœê·¸ ì°¾ê¸° (ì¤‘ì²© ê³ ë ¤)
            let depth = 1;
            let pos = searchArea.length - 1;
            let prevStart = -1;

            while (pos >= 0 && depth > 0) {
                const closePattern = new RegExp('</' + tagName + '>', 'gi');
                const openPattern = new RegExp('<' + tagName + '[^>]*>', 'gi');

                // í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì´ì „ íƒœê·¸ ì°¾ê¸°
                const chunk = searchArea.substring(Math.max(0, pos - 100), pos + 1);
                const lastClose = chunk.lastIndexOf('</' + tagName);
                const lastOpen = chunk.search(new RegExp('<' + tagName + '[^>]*>(?!.*<' + tagName + ')'));

                if (lastClose > lastOpen && lastClose !== -1) {
                    depth++;
                    pos = pos - (chunk.length - lastClose) - 1;
                } else if (lastOpen !== -1) {
                    depth--;
                    if (depth === 0) {
                        prevStart = Math.max(0, pos - 100) + lastOpen;
                    }
                    pos = pos - (chunk.length - lastOpen) - 1;
                } else {
                    pos -= 50;
                }
            }

            if (prevStart === -1) {
                // ê°„ë‹¨í•œ ë°©ë²•ìœ¼ë¡œ ì‹œë„: ë°”ë¡œ ì´ì „ ì¤„ ë‹¨ìœ„ë¡œ ì°¾ê¸°
                const lines = beforeContent.split('\n');
                let accLength = 0;
                for (let i = 0; i < lines.length - 1; i++) {
                    accLength += lines[i].length + 1;
                }
                // ì´ì „ ì¤„ ì‹œì‘ ìœ„ì¹˜ë¥¼ prevStartë¡œ ì‚¬ìš©
                const prevLineStart = beforeContent.lastIndexOf('\n', start - selectedHTML.length - 2);
                if (prevLineStart > 0) {
                    prevStart = beforeContent.lastIndexOf('\n', prevLineStart - 1) + 1;
                } else {
                    prevStart = 0;
                }
            }

            // ì´ì „ ìš”ì†Œì˜ HTML
            const prevHTML = content.substring(prevStart, start);

            // ìœ„ì¹˜ êµí™˜
            const editor = document.getElementById('htmlEditor');
            const newContent = content.substring(0, prevStart) + selectedHTML + prevHTML + content.substring(end);
            editor.value = newContent;

            // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            updatePreview();

            // ìƒˆ ìœ„ì¹˜ ì„ íƒ
            setTimeout(() => {
                editor.setSelectionRange(prevStart, prevStart + selectedHTML.length);
                editor.focus();
                lastFoundPosition = { start: prevStart, end: prevStart + selectedHTML.length };
            }, 100);

            showNotification('ìœ„ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // ì•„ë˜ë¡œ ì´ë™
        function moveDown(content, selectedHTML, start, end) {
            // ë‹¤ìŒ í˜•ì œ ìš”ì†Œ ì°¾ê¸°
            const afterContent = content.substring(end);
            const nextOpenMatch = afterContent.match(/^\s*<(\w+)[^>]*>/);

            if (!nextOpenMatch) {
                showNotification('ë” ì´ìƒ ì•„ë˜ë¡œ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            // ë‹¤ìŒ ìš”ì†Œì˜ ë‹«ëŠ” íƒœê·¸ ì°¾ê¸°
            const tagName = nextOpenMatch[1];
            const closeTag = '</' + tagName + '>';
            let depth = 1;
            let searchPos = nextOpenMatch[0].length;

            while (depth > 0 && searchPos < afterContent.length) {
                const nextClose = afterContent.indexOf(closeTag, searchPos);
                const nextOpen = afterContent.indexOf('<' + tagName, searchPos);

                if (nextClose === -1) break;

                if (nextOpen !== -1 && nextOpen < nextClose) {
                    depth++;
                    searchPos = nextOpen + 1;
                } else {
                    depth--;
                    if (depth === 0) {
                        searchPos = nextClose + closeTag.length;
                    } else {
                        searchPos = nextClose + 1;
                    }
                }
            }

            const nextEnd = end + searchPos;
            const nextHTML = content.substring(end, nextEnd);

            // ìœ„ì¹˜ êµí™˜
            const editor = document.getElementById('htmlEditor');
            const newContent = content.substring(0, start) + nextHTML + selectedHTML + content.substring(nextEnd);
            editor.value = newContent;

            // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            updatePreview();

            // ìƒˆ ìœ„ì¹˜ ì„ íƒ
            const newStart = start + nextHTML.length;
            setTimeout(() => {
                editor.setSelectionRange(newStart, newStart + selectedHTML.length);
                editor.focus();
                lastFoundPosition = { start: newStart, end: newStart + selectedHTML.length };
            }, 100);

            showNotification('ì•„ë˜ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // ìš”ì†Œ ì‚­ì œ
        function deleteElement() {
            if (!selectedElement || !lastFoundPosition) {
                showNotification('ë¨¼ì € ìš”ì†Œë¥¼ ì„ íƒí•˜ì„¸ìš”.', 'error');
                return;
            }

            if (!confirm('ì„ íƒí•œ ìš”ì†Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const editor = document.getElementById('htmlEditor');
            let content = editor.value;
            const { start, end } = lastFoundPosition;

            // ìš”ì†Œ ì‚­ì œ
            const newContent = content.substring(0, start) + content.substring(end);
            editor.value = newContent;

            // ì„ íƒ í•´ì œ
            deselectElement();

            // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            updatePreview();

            showNotification('ìš”ì†Œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // ìš”ì†Œ ë³µì œ
        function duplicateElement() {
            if (!selectedElement || !lastFoundPosition) {
                showNotification('ë¨¼ì € ìš”ì†Œë¥¼ ì„ íƒí•˜ì„¸ìš”.', 'error');
                return;
            }

            const editor = document.getElementById('htmlEditor');
            let content = editor.value;
            const { start, end } = lastFoundPosition;

            // ì„ íƒëœ HTML ë¸”ë¡
            const selectedHTML = content.substring(start, end);

            // ë³µì œ (ë°”ë¡œ ì•„ë˜ì— ì¶”ê°€)
            const newContent = content.substring(0, end) + '\n' + selectedHTML + content.substring(end);
            editor.value = newContent;

            // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            updatePreview();

            // ìƒˆ ìš”ì†Œ ì„ íƒ
            const newStart = end + 1;
            setTimeout(() => {
                editor.setSelectionRange(newStart, newStart + selectedHTML.length);
                editor.focus();
                lastFoundPosition = { start: newStart, end: newStart + selectedHTML.length };
            }, 100);

            showNotification('ìš”ì†Œê°€ ë³µì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // ë¯¸ë¦¬ë³´ê¸°ì—ì„œ í‚¤ë³´ë“œ ì´ë²¤íŠ¸
        function onPreviewKeydown(e) {
            if (!isSyncModeActive || !selectedElement) return;

            switch (e.key) {
                case 'ArrowUp':
                    e.preventDefault();
                    moveElement('up');
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    moveElement('down');
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    moveElement('left');
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    moveElement('right');
                    break;
                case 'Delete':
                case 'Backspace':
                    e.preventDefault();
                    deleteElement();
                    break;
                case 'Escape':
                    e.preventDefault();
                    deselectElement();
                    break;
            }
        }

        // ë©”ì¸ ë¬¸ì„œì—ì„œë„ í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì²˜ë¦¬ (ì´ë™ ì»¨íŠ¸ë¡¤ íŒ¨ë„ì´ í™œì„±í™”ëœ ê²½ìš°)
        document.addEventListener('keydown', (e) => {
            if (!isSyncModeActive || !selectedElement) return;
            if (document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'INPUT') return;

            switch (e.key) {
                case 'ArrowUp':
                    e.preventDefault();
                    moveElement('up');
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    moveElement('down');
                    break;
                case 'Escape':
                    e.preventDefault();
                    deselectElement();
                    break;
            }
        });

        // ==========================================
        // ì´ë¯¸ì§€ ì—…ë¡œë“œ/ì‚½ì… ê¸°ëŠ¥
        // ==========================================

        let selectedImageFile = null;
        let selectedImageUrl = '';

        // ì´ë¯¸ì§€ ëª¨ë‹¬ ì—´ê¸°
        function openImageUpload() {
            document.getElementById('imageModal').style.display = 'flex';
            switchImageTab('upload');
            selectedImageFile = null;
            selectedImageUrl = '';
            document.getElementById('uploadPreview').style.display = 'none';
            document.getElementById('urlPreview').style.display = 'none';
            document.getElementById('imageUrlInput').value = '';
            document.getElementById('imageAltText').value = '';
            loadServerImages();
        }

        // ì´ë¯¸ì§€ ëª¨ë‹¬ ë‹«ê¸°
        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
            selectedImageFile = null;
            selectedImageUrl = '';
        }

        // íƒ­ ì „í™˜
        function switchImageTab(tab) {
            const tabs = ['upload', 'url', 'gallery'];
            tabs.forEach(t => {
                document.getElementById(t + 'Tab').style.display = t === tab ? 'block' : 'none';
                const btn = document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1));
                if (t === tab) {
                    btn.style.background = '#10B981';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#10B981';
                } else {
                    btn.style.background = 'white';
                    btn.style.color = '#666';
                    btn.style.borderColor = '#ddd';
                }
            });
        }

        // ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (file) {
                previewImageFile(file);
            }
        }

        // ì´ë¯¸ì§€ ë“œë˜ê·¸ ì•¤ ë“œë¡­
        function handleImageDrop(event) {
            event.preventDefault();
            event.target.style.borderColor = '#ddd';
            event.target.style.background = 'white';

            const file = event.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                previewImageFile(file);
            }
        }

        // ì´ë¯¸ì§€ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
        function previewImageFile(file) {
            selectedImageFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('previewFileName').textContent = file.name + ' (' + formatFileSize(file.size) + ')';
                document.getElementById('uploadPreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        // URL ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
        function previewUrlImage() {
            const url = document.getElementById('imageUrlInput').value.trim();
            if (!url) {
                showNotification('URLì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }
            selectedImageUrl = url;
            document.getElementById('urlPreviewImg').src = url;
            document.getElementById('urlPreview').style.display = 'block';
        }

        // ì„œë²„ ì´ë¯¸ì§€ ëª©ë¡ ë¡œë“œ
        async function loadServerImages() {
            try {
                const response = await fetch('/api/files/static');
                const data = await response.json();

                if (data.success) {
                    const imageFiles = data.files.filter(f => /\.(jpg|jpeg|png|gif|webp|svg)$/i.test(f.name));
                    const container = document.getElementById('serverImages');

                    if (imageFiles.length === 0) {
                        container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999;">ì„œë²„ì— ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                        return;
                    }

                    container.innerHTML = imageFiles.map(f => `
                        <div onclick="selectServerImage('${f.url}')" style="cursor: pointer; border: 2px solid #eee; border-radius: 8px; overflow: hidden; transition: all 0.2s;" onmouseover="this.style.borderColor='#10B981'" onmouseout="this.style.borderColor='#eee'">
                            <img src="${f.url}" style="width: 100%; height: 80px; object-fit: cover;">
                            <p style="margin: 0; padding: 5px; font-size: 11px; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${f.name}</p>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('ì„œë²„ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì„œë²„ ì´ë¯¸ì§€ ì„ íƒ
        function selectServerImage(url) {
            selectedImageUrl = url;
            showNotification('ì´ë¯¸ì§€ ì„ íƒë¨: ' + url.split('/').pop(), 'success');
        }

        // ì´ë¯¸ì§€ ì‚½ì…
        async function insertImage() {
            const alt = document.getElementById('imageAltText').value || 'ì´ë¯¸ì§€';
            let imageUrl = '';

            // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
            if (selectedImageFile) {
                const formData = new FormData();
                formData.append('file', selectedImageFile);

                try {
                    showNotification('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...', 'success');
                    const response = await fetch('/api/upload-image', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    if (result.success) {
                        imageUrl = result.url;
                    } else {
                        showNotification('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + result.message, 'error');
                        return;
                    }
                } catch (error) {
                    showNotification('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
                    return;
                }
            } else if (selectedImageUrl) {
                imageUrl = selectedImageUrl;
            } else {
                showNotification('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }

            // HTML ì—ë””í„°ì— ì´ë¯¸ì§€ íƒœê·¸ ì‚½ì…
            const editor = document.getElementById('htmlEditor');
            const imgTag = `<img src="${imageUrl}" alt="${alt}" style="max-width: 100%; height: auto;">`;

            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const text = editor.value;

            editor.value = text.substring(0, start) + imgTag + text.substring(end);
            editor.selectionStart = editor.selectionEnd = start + imgTag.length;
            editor.focus();

            updatePreview();
            markAsModified();
            closeImageModal();
            showNotification('ì´ë¯¸ì§€ê°€ ì‚½ì…ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }

        // ë§í¬ ì‚½ì…
        function insertLink() {
            const url = prompt('ë§í¬ URLì„ ì…ë ¥í•˜ì„¸ìš”:', 'https://');
            if (!url) return;

            const text = prompt('í‘œì‹œí•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', 'ë§í¬');
            if (!text) return;

            const editor = document.getElementById('htmlEditor');
            const linkTag = `<a href="${url}" target="_blank">${text}</a>`;

            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const editorText = editor.value;

            editor.value = editorText.substring(0, start) + linkTag + editorText.substring(end);
            editor.selectionStart = editor.selectionEnd = start + linkTag.length;
            editor.focus();

            updatePreview();
            markAsModified();
            showNotification('ë§í¬ê°€ ì‚½ì…ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }

        // íŒŒì¼ í¬ê¸° í¬ë§·
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // ============================================
        // í…ìŠ¤íŠ¸ ê²€ì¦ ê¸°ëŠ¥
        // ============================================

        // ê²€ì¦ ëª¨ë‹¬ ì—´ê¸°
        function openValidation() {
            document.getElementById('validationModal').style.display = 'flex';
            document.getElementById('validationResult').style.display = 'none';

            // í˜„ì¬ HTMLì—ì„œ í…ìŠ¤íŠ¸ ìë™ ì¶”ì¶œ
            extractHtmlText();
        }

        // ê²€ì¦ ëª¨ë‹¬ ë‹«ê¸°
        function closeValidationModal() {
            document.getElementById('validationModal').style.display = 'none';
        }

        // HTMLì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
        function extractHtmlText() {
            const htmlContent = document.getElementById('htmlEditor').value;

            // HTML íƒœê·¸ ì œê±°í•˜ê³  í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;

            // ìŠ¤í¬ë¦½íŠ¸, ìŠ¤íƒ€ì¼ íƒœê·¸ ì œê±°
            const scripts = tempDiv.querySelectorAll('script, style');
            scripts.forEach(s => s.remove());

            // í…ìŠ¤íŠ¸ ì¶”ì¶œ
            let text = tempDiv.textContent || tempDiv.innerText;

            // ì—°ì† ê³µë°± ì •ë¦¬
            text = text.replace(/\s+/g, ' ').trim();

            document.getElementById('convertedText').value = text;
        }

        // ê²€ì¦ ì‹¤í–‰
        async function runValidation() {
            const original = document.getElementById('originalText').value.trim();
            const converted = document.getElementById('convertedText').value.trim();

            if (!original) {
                showNotification('ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            if (!converted) {
                showNotification('ë³€í™˜ëœ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }

            try {
                showNotification('ê²€ì¦ ì¤‘...', 'success');

                const response = await fetch('/api/learning/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ original, converted })
                });

                const result = await response.json();

                if (result.success) {
                    displayValidationResult(result.validation);
                } else {
                    showNotification('ê²€ì¦ ì‹¤íŒ¨: ' + result.detail, 'error');
                }
            } catch (error) {
                console.error('ê²€ì¦ ì˜¤ë¥˜:', error);
                showNotification('ê²€ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        // ê²€ì¦ ê²°ê³¼ í‘œì‹œ
        function displayValidationResult(validation) {
            const resultDiv = document.getElementById('validationResult');
            const summaryDiv = document.getElementById('validationSummary');
            const errorsDiv = document.getElementById('validationErrors');

            resultDiv.style.display = 'block';

            // ì •í™•ë„ ìƒ‰ìƒ ê²°ì •
            let accuracyColor = '#10B981';  // ë…¹ìƒ‰
            if (validation.accuracy < 0.9) accuracyColor = '#F59E0B';  // ë…¸ë€ìƒ‰
            if (validation.accuracy < 0.7) accuracyColor = '#EF4444';  // ë¹¨ê°„ìƒ‰

            // ìš”ì•½ í‘œì‹œ
            summaryDiv.innerHTML = `
                <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 15px;">
                    <div style="text-align: center; padding: 15px 25px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size: 2em; font-weight: bold; color: ${accuracyColor};">${validation.accuracy_percent}</div>
                        <div style="color: #666; font-size: 0.9em;">ì •í™•ë„</div>
                    </div>
                    <div style="text-align: center; padding: 15px 25px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size: 2em; font-weight: bold; color: #333;">${validation.total_chars}</div>
                        <div style="color: #666; font-size: 0.9em;">ì´ ë¬¸ì</div>
                    </div>
                    <div style="text-align: center; padding: 15px 25px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size: 2em; font-weight: bold; color: ${validation.total_errors > 0 ? '#EF4444' : '#10B981'};">${validation.total_errors}</div>
                        <div style="color: #666; font-size: 0.9em;">ì˜¤ë¥˜ ìˆ˜</div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    ${validation.summary.typo > 0 ? `<span style="padding: 4px 10px; background: #FEE2E2; color: #B91C1C; border-radius: 4px; font-size: 0.85em;">ì˜¤ì ${validation.summary.typo}</span>` : ''}
                    ${validation.summary.missing > 0 ? `<span style="padding: 4px 10px; background: #FEF3C7; color: #92400E; border-radius: 4px; font-size: 0.85em;">íƒˆì ${validation.summary.missing}</span>` : ''}
                    ${validation.summary.extra > 0 ? `<span style="padding: 4px 10px; background: #DBEAFE; color: #1E40AF; border-radius: 4px; font-size: 0.85em;">ì²¨ì ${validation.summary.extra}</span>` : ''}
                    ${validation.summary.ocr > 0 ? `<span style="padding: 4px 10px; background: #F3E8FF; color: #6B21A8; border-radius: 4px; font-size: 0.85em;">OCRì˜¤ë¥˜ ${validation.summary.ocr}</span>` : ''}
                    ${validation.summary.context > 0 ? `<span style="padding: 4px 10px; background: #FCE7F3; color: #9D174D; border-radius: 4px; font-size: 0.85em;">ë¬¸ë§¥ì˜¤ë¥˜ ${validation.summary.context}</span>` : ''}
                </div>
            `;

            // ì˜¤ë¥˜ ìƒì„¸ í‘œì‹œ
            if (validation.errors.length > 0) {
                errorsDiv.innerHTML = `
                    <h4 style="margin: 15px 0 10px; color: #333;">ğŸ” ë°œê²¬ëœ ì˜¤ë¥˜ (ìƒìœ„ 20ê°œ)</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        ${validation.errors.slice(0, 20).map(error => `
                            <div style="padding: 10px; background: white; border-radius: 6px; border-left: 4px solid ${getErrorColor(error.type)};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                    <span style="font-weight: 600; color: ${getErrorColor(error.type)};">${getErrorTypeName(error.type)}</span>
                                    <span style="font-size: 0.8em; color: #999;">ì‹ ë¢°ë„ ${Math.round(error.confidence * 100)}%</span>
                                </div>
                                <div style="font-size: 0.9em; color: #333;">
                                    ${error.original ? `<span style="background: #FEE2E2; padding: 2px 4px; border-radius: 3px; text-decoration: line-through;">${escapeHtml(error.original)}</span>` : ''}
                                    ${error.converted ? `<span style="background: #DBEAFE; padding: 2px 4px; border-radius: 3px;">${escapeHtml(error.converted)}</span>` : ''}
                                </div>
                                <div style="font-size: 0.85em; color: #666; margin-top: 5px;">ğŸ’¡ ${escapeHtml(error.suggestion)}</div>
                                ${error.context ? `<div style="font-size: 0.8em; color: #999; margin-top: 3px; font-family: monospace;">...${escapeHtml(error.context)}...</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                errorsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #10B981;">âœ… ì˜¤ë¥˜ê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!</div>';
            }

            showNotification(`ê²€ì¦ ì™„ë£Œ: ì •í™•ë„ ${validation.accuracy_percent}`, validation.accuracy >= 0.9 ? 'success' : 'error');
        }

        // ì˜¤ë¥˜ ìœ í˜•ë³„ ìƒ‰ìƒ
        function getErrorColor(type) {
            const colors = {
                'typo': '#EF4444',
                'missing': '#F59E0B',
                'extra': '#3B82F6',
                'split': '#8B5CF6',
                'merge': '#EC4899',
                'context': '#F97316',
                'ocr': '#6366F1'
            };
            return colors[type] || '#6B7280';
        }

        // ì˜¤ë¥˜ ìœ í˜• ì´ë¦„
        function getErrorTypeName(type) {
            const names = {
                'typo': 'ì˜¤ì',
                'missing': 'íƒˆì',
                'extra': 'ì²¨ì',
                'split': 'ë¶„ë¦¬ì˜¤ë¥˜',
                'merge': 'ë³‘í•©ì˜¤ë¥˜',
                'context': 'ë¬¸ë§¥ì˜¤ë¥˜',
                'ocr': 'OCRì˜¤ë¥˜'
            };
            return names[type] || type;
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>

    <!-- PDF ì—…ë¡œë“œ ëª¨ë‹¬ -->
    <div id="pdfModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 12px; padding: 25px; max-width: 600px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #333;">ğŸ“„ PDFë¥¼ HTMLë¡œ ë³€í™˜</h3>
                <button onclick="closePdfModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>

            <!-- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì˜ì—­ -->
            <div id="pdfDropZone" style="border: 2px dashed #8B5CF6; border-radius: 12px; padding: 50px; text-align: center; margin-bottom: 20px; cursor: pointer; transition: all 0.3s; background: #f9f5ff;"
                 onclick="document.getElementById('pdfFileInput').click()"
                 ondragover="event.preventDefault(); this.style.borderColor='#6D28D9'; this.style.background='#ede9fe';"
                 ondragleave="this.style.borderColor='#8B5CF6'; this.style.background='#f9f5ff';"
                 ondrop="handlePdfDrop(event)">
                <div style="font-size: 64px; margin-bottom: 15px;">ğŸ“„</div>
                <p style="margin: 0; color: #6D28D9; font-weight: 600; font-size: 1.1em;">í´ë¦­í•˜ê±°ë‚˜ PDF íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                <p style="margin: 10px 0 0; color: #9333EA; font-size: 0.9em;">PDF íŒŒì¼ë§Œ ì§€ì›ë©ë‹ˆë‹¤ (ìµœëŒ€ 50MB)</p>
            </div>
            <input type="file" id="pdfFileInput" accept=".pdf,application/pdf" style="display: none;" onchange="handlePdfSelect(event)">

            <!-- ì„ íƒëœ íŒŒì¼ ì •ë³´ -->
            <div id="pdfFileInfo" style="display: none; padding: 15px; background: #f3f4f6; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 32px;">ğŸ“‹</div>
                    <div style="flex: 1;">
                        <div id="pdfFileName" style="font-weight: 600; color: #333;"></div>
                        <div id="pdfFileSize" style="font-size: 0.85em; color: #666;"></div>
                    </div>
                    <button onclick="clearPdfSelection()" style="background: #EF4444; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer;">âœ• ì œê±°</button>
                </div>
            </div>

            <!-- ë³€í™˜ ì˜µì…˜ -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">ì¶œë ¥ íŒŒì¼ëª… (ì„ íƒ):</label>
                <input type="text" id="pdfOutputName" placeholder="ìë™ ìƒì„±ë¨ (ì˜ˆ: document_20251205_123456.html)" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
            </div>

            <!-- ë³€í™˜ ì§„í–‰ ìƒíƒœ -->
            <div id="pdfProgress" style="display: none; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <div class="spinner" style="width: 20px; height: 20px; border: 3px solid #ddd; border-top-color: #8B5CF6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <span id="pdfProgressText" style="color: #666;">ë³€í™˜ ì¤‘...</span>
                </div>
                <div style="background: #e5e7eb; border-radius: 4px; height: 8px; overflow: hidden;">
                    <div id="pdfProgressBar" style="background: linear-gradient(90deg, #8B5CF6, #6D28D9); height: 100%; width: 0%; transition: width 0.3s;"></div>
                </div>
            </div>

            <!-- ë²„íŠ¼ -->
            <div style="display: flex; gap: 10px;">
                <button onclick="closePdfModal()" style="flex: 1; padding: 14px; background: #f3f4f6; color: #666; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px;">ì·¨ì†Œ</button>
                <button id="pdfConvertBtn" onclick="convertPdf()" style="flex: 2; padding: 14px; background: #8B5CF6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px;" disabled>ğŸ“„ ë³€í™˜ ì‹œì‘</button>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <!-- AI í”¼ë“œë°± ëª¨ë‹¬ -->
    <div id="feedbackModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 16px; padding: 25px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #333;">ğŸ§  AI í•™ìŠµ í”¼ë“œë°±</h3>
                <button onclick="closeFeedbackModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>

            <!-- í‰ì  -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">ë³€í™˜ í’ˆì§ˆ í‰ê°€:</label>
                <div id="ratingStars" style="display: flex; gap: 8px; font-size: 32px; cursor: pointer;">
                    <span onclick="setRating(1)" data-rating="1">â˜†</span>
                    <span onclick="setRating(2)" data-rating="2">â˜†</span>
                    <span onclick="setRating(3)" data-rating="3">â˜†</span>
                    <span onclick="setRating(4)" data-rating="4">â˜†</span>
                    <span onclick="setRating(5)" data-rating="5">â˜†</span>
                </div>
                <input type="hidden" id="feedbackRating" value="0">
            </div>

            <!-- í”¼ë“œë°± ìœ í˜• -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">í”¼ë“œë°± ìœ í˜•:</label>
                <select id="feedbackType" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                    <option value="rating">ì¼ë°˜ í‰ê°€</option>
                    <option value="correction">ì˜¤ë¥˜ ìˆ˜ì • ì œë³´</option>
                    <option value="suggestion">ê°œì„  ì œì•ˆ</option>
                </select>
            </div>

            <!-- ì¹´í…Œê³ ë¦¬ -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">ê´€ë ¨ ì¹´í…Œê³ ë¦¬:</label>
                <select id="feedbackCategory" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                    <option value="overall">ì „ì²´</option>
                    <option value="party">ì •ë‹¹ ì •ë³´</option>
                    <option value="name">í›„ë³´ì ì´ë¦„</option>
                    <option value="pledge">ê³µì•½</option>
                    <option value="layout">ë ˆì´ì•„ì›ƒ</option>
                    <option value="color">ìƒ‰ìƒ/í…Œë§ˆ</option>
                    <option value="image">ì´ë¯¸ì§€</option>
                </select>
            </div>

            <!-- ìˆ˜ì • ë‚´ìš© (ì˜¤ë¥˜ ìˆ˜ì • ì‹œ) -->
            <div id="correctionFields" style="display: none; margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">ì›ë˜ ê°’:</label>
                <input type="text" id="originalValue" placeholder="ì˜ëª»ëœ ê°’" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; margin-bottom: 10px; box-sizing: border-box;">

                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">ìˆ˜ì •ëœ ê°’:</label>
                <input type="text" id="correctedValue" placeholder="ì˜¬ë°”ë¥¸ ê°’" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
            </div>

            <!-- ì½”ë©˜íŠ¸ -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">ì¶”ê°€ ì˜ê²¬:</label>
                <textarea id="feedbackComment" placeholder="AIê°€ ë” ì˜ í•™ìŠµí•  ìˆ˜ ìˆë„ë¡ ì˜ê²¬ì„ ë‚¨ê²¨ì£¼ì„¸ìš”" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; min-height: 80px; resize: vertical; box-sizing: border-box;"></textarea>
            </div>

            <!-- ì €ì¥ ì‹œ HTML ë³€ê²½ ë¹„êµ -->
            <div style="margin-bottom: 20px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="saveHtmlDiff" checked style="width: 18px; height: 18px;">
                    <span style="color: #333;">ì €ì¥ ì‹œ HTML ë³€ê²½ ë‚´ìš©ë„ í•™ìŠµì— í™œìš©</span>
                </label>
            </div>

            <!-- í•™ìŠµ í†µê³„ í‘œì‹œ -->
            <div id="learningStats" style="background: #f3f4f6; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <div style="font-weight: 600; color: #333; margin-bottom: 10px;">ğŸ“Š AI í•™ìŠµ í˜„í™©</div>
                <div id="statsContent" style="font-size: 0.9em; color: #666;">ë¡œë”© ì¤‘...</div>
            </div>

            <!-- ë²„íŠ¼ -->
            <div style="display: flex; gap: 10px;">
                <button onclick="closeFeedbackModal()" style="flex: 1; padding: 14px; background: #f3f4f6; color: #666; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">ì·¨ì†Œ</button>
                <button onclick="submitFeedback()" style="flex: 2; padding: 14px; background: #8B5CF6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">ğŸ§  í”¼ë“œë°± ì „ì†¡</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // AI í”¼ë“œë°± ê¸°ëŠ¥
        // ============================================

        let currentRating = 0;
        let originalHtmlContent = '';  // íŒŒì¼ ë¡œë“œ ì‹œ ì›ë³¸ ì €ì¥

        // í”¼ë“œë°± ëª¨ë‹¬ ì—´ê¸°
        function openFeedbackModal() {
            if (!currentFile) {
                showNotification('íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }
            document.getElementById('feedbackModal').style.display = 'flex';
            loadLearningStats();

            // í”¼ë“œë°± ìœ í˜•ì— ë”°ë¼ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
            document.getElementById('feedbackType').addEventListener('change', function() {
                document.getElementById('correctionFields').style.display =
                    this.value === 'correction' ? 'block' : 'none';
            });
        }

        // í”¼ë“œë°± ëª¨ë‹¬ ë‹«ê¸°
        function closeFeedbackModal() {
            document.getElementById('feedbackModal').style.display = 'none';
            resetFeedbackForm();
        }

        // í‰ì  ì„¤ì •
        function setRating(rating) {
            currentRating = rating;
            document.getElementById('feedbackRating').value = rating;

            const stars = document.querySelectorAll('#ratingStars span');
            stars.forEach((star, index) => {
                star.textContent = index < rating ? 'â˜…' : 'â˜†';
                star.style.color = index < rating ? '#F59E0B' : '#D1D5DB';
            });
        }

        // í”¼ë“œë°± ì „ì†¡
        async function submitFeedback() {
            const rating = parseInt(document.getElementById('feedbackRating').value);
            if (rating === 0) {
                showNotification('í‰ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
                return;
            }

            const feedbackData = {
                job_id: currentFile.replace('.html', ''),
                rating: rating,
                feedback_type: document.getElementById('feedbackType').value,
                category: document.getElementById('feedbackCategory').value,
                original_value: document.getElementById('originalValue').value,
                corrected_value: document.getElementById('correctedValue').value,
                comment: document.getElementById('feedbackComment').value
            };

            try {
                // í”¼ë“œë°± ì „ì†¡
                const response = await fetch('/api/learning/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(feedbackData)
                });

                if (response.ok) {
                    // HTML ë³€ê²½ ë¹„êµ ì €ì¥
                    if (document.getElementById('saveHtmlDiff').checked && originalHtmlContent) {
                        const currentHtml = document.getElementById('htmlEditor').value;
                        if (currentHtml !== originalHtmlContent) {
                            await saveHtmlDiff(currentHtml);
                        }
                    }

                    showNotification('í”¼ë“œë°±ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. AIê°€ í•™ìŠµí•©ë‹ˆë‹¤!', 'success');
                    closeFeedbackModal();
                } else {
                    throw new Error('ì „ì†¡ ì‹¤íŒ¨');
                }
            } catch (e) {
                console.error(e);
                showNotification('í”¼ë“œë°± ì „ì†¡ ì‹¤íŒ¨', 'error');
            }
        }

        // HTML ë³€ê²½ ë¹„êµ ì €ì¥
        async function saveHtmlDiff(modifiedHtml) {
            try {
                await fetch('/api/learning/html-diff', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_id: currentFile.replace('.html', ''),
                        original_html: originalHtmlContent,
                        modified_html: modifiedHtml
                    })
                });
            } catch (e) {
                console.error('HTML diff ì €ì¥ ì‹¤íŒ¨:', e);
            }
        }

        // í•™ìŠµ í†µê³„ ë¡œë“œ
        async function loadLearningStats() {
            try {
                const response = await fetch('/api/learning/stats');
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('statsContent').innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>ğŸ“ ì´ í”¼ë“œë°±: <strong>${stats.total_feedbacks || 0}ê±´</strong></div>
                            <div>ğŸ§  í•™ìŠµ ê·œì¹™: <strong>${stats.active_rules || 0}ê°œ</strong></div>
                            <div>ğŸ‘ ê¸ì • í”¼ë“œë°±: <strong>${stats.positive_feedbacks || 0}ê±´</strong></div>
                            <div>âš¡ ê³ ì‹ ë¢° ê·œì¹™: <strong>${stats.high_confidence_rules || 0}ê°œ</strong></div>
                        </div>
                    `;
                }
            } catch (e) {
                document.getElementById('statsContent').innerHTML = 'í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }
        }

        // í¼ ì´ˆê¸°í™”
        function resetFeedbackForm() {
            currentRating = 0;
            document.getElementById('feedbackRating').value = '0';
            setRating(0);
            document.getElementById('feedbackType').value = 'rating';
            document.getElementById('feedbackCategory').value = 'overall';
            document.getElementById('originalValue').value = '';
            document.getElementById('correctedValue').value = '';
            document.getElementById('feedbackComment').value = '';
            document.getElementById('correctionFields').style.display = 'none';
        }

        // íŒŒì¼ ë¡œë“œ ì‹œ ì›ë³¸ ì €ì¥ (ê¸°ì¡´ loadFile í•¨ìˆ˜ ìˆ˜ì •)
        const originalLoadFile = loadFile;
        loadFile = async function(filename) {
            await originalLoadFile(filename);
            // ì›ë³¸ HTML ì €ì¥
            originalHtmlContent = document.getElementById('htmlEditor').value;
        };
    </script>

</body>
</html>
