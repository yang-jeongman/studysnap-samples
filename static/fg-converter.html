<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FG Church Bulletin Converter</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #5B2C6F 0%, #4A235A 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 800px; margin: 0 auto; }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .header .church-name {
            font-size: 1.4em;
            font-weight: 700;
            color: #F5D0A9;
            margin-top: 8px;
        }

        .trial-badge {
            display: inline-block;
            background: linear-gradient(135deg, #F39C12, #E67E22);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.7em;
            font-weight: 600;
            margin-top: 10px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .card-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #5B2C6F;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-area {
            border: 3px dashed #9B59B6;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: #F8F4FC;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #5B2C6F;
            background: #F0E6F6;
        }

        .upload-area.has-file {
            border-color: #27AE60;
            background: #F0FFF4;
        }

        .upload-icon { font-size: 4em; margin-bottom: 15px; }
        .upload-area h3 { font-size: 1.3em; color: #5B2C6F; margin-bottom: 10px; }
        .upload-area p { color: #7D3C98; font-size: 0.95em; }

        .file-input { display: none; }

        .file-info {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 2px solid #27AE60;
        }

        .file-info .icon { font-size: 2em; }
        .file-info .details { flex: 1; text-align: left; }
        .file-info .name { font-weight: 600; color: #5B2C6F; }
        .file-info .size { color: #7D3C98; font-size: 0.9em; }

        .file-info .remove {
            background: #fee2e2;
            color: #dc2626;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .settings-section {
            margin-top: 25px;
            padding: 20px;
            background: #F8F4FC;
            border-radius: 12px;
            border: 1px solid #E8D4F0;
        }

        .settings-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .settings-row:last-child { margin-bottom: 0; }

        .settings-label {
            font-weight: 600;
            color: #5B2C6F;
            min-width: 100px;
        }

        .settings-value {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #E8D4F0;
            border-radius: 8px;
            font-size: 1em;
            background: white;
        }

        .settings-value.fixed {
            background: #F0E6F6;
            color: #5B2C6F;
            font-weight: 600;
            border-color: #9B59B6;
        }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .theme-option {
            padding: 12px 8px;
            border: 2px solid #E8D4F0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .theme-option:hover { border-color: #9B59B6; }
        .theme-option.selected {
            border-color: #5B2C6F;
            background: #F0E6F6;
        }

        .theme-option .icon { font-size: 1.5em; margin-bottom: 5px; }
        .theme-option .name { font-size: 0.85em; font-weight: 600; color: #5B2C6F; }

        .convert-btn {
            width: 100%;
            padding: 18px;
            font-size: 1.2em;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 25px;
        }

        .convert-btn.ready {
            background: linear-gradient(135deg, #5B2C6F 0%, #9B59B6 100%);
            color: white;
        }

        .convert-btn.ready:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(91, 44, 111, 0.4);
        }

        .convert-btn.disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .convert-btn.loading {
            background: linear-gradient(135deg, #F39C12 0%, #E67E22 100%);
            color: white;
        }

        .progress-container {
            margin-top: 20px;
            display: none;
        }

        .progress-container.show { display: block; }

        .progress-bar {
            height: 12px;
            background: #E8D4F0;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #5B2C6F, #9B59B6, #5B2C6F);
            background-size: 200% 100%;
            animation: progressShine 2s linear infinite;
            width: 0%;
            transition: width 0.5s ease-out;
        }

        @keyframes progressShine {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .progress-text {
            text-align: center;
            margin-top: 12px;
            color: #5B2C6F;
            font-weight: 600;
            font-size: 1.05em;
        }

        .progress-timer {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.9em;
            color: #7D3C98;
        }

        .progress-timer .elapsed {
            font-weight: 600;
        }

        .progress-timer .remaining {
            font-weight: 500;
            color: #27AE60;
        }

        .result-container {
            display: none;
        }

        .result-container.show { display: block; }

        .result-success {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 12px;
            color: white;
            margin-bottom: 20px;
        }

        .result-success h3 { margin-bottom: 10px; }

        .result-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .result-item {
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 8px;
        }

        .result-item .label { font-size: 0.8em; opacity: 0.8; }
        .result-item .value { font-weight: 600; }

        .result-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .result-actions a, .result-actions button {
            flex: 1;
            padding: 12px 20px;
            border-radius: 8px;
            text-decoration: none;
            text-align: center;
            font-weight: 600;
            min-width: 120px;
        }

        .btn-preview {
            background: #5B2C6F;
            color: white;
        }

        .btn-download {
            background: #27AE60;
            color: white;
        }

        .btn-reset {
            background: #6c757d;
            color: white;
            border: none;
            cursor: pointer;
        }

        .btn-clear {
            background: #dc3545;
            color: white;
            border: none;
            cursor: pointer;
        }

        .error-container {
            background: #fee2e2;
            color: #dc2626;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }

        .error-container.show { display: block; }

        .cache-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .cache-warning h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .cache-warning p {
            color: #856404;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .cache-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .cache-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .license-info {
            background: linear-gradient(135deg, #E8F8F5 0%, #D5F5E3 100%);
            border: 2px solid #27AE60;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .license-info .left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .license-info .icon { font-size: 1.5em; }
        .license-info .text { color: #1E8449; font-weight: 600; }
        .license-info .days {
            background: #27AE60;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 700;
        }

        @media (max-width: 600px) {
            .theme-grid { grid-template-columns: repeat(2, 1fr); }
            .result-info { grid-template-columns: 1fr; }
            .settings-row { flex-direction: column; align-items: stretch; }
            .settings-label { min-width: auto; margin-bottom: 5px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FG Church Bulletin Converter</h1>
            <div class="subtitle">PDF to Interactive Mobile HTML</div>
            <div class="church-name">Yoido Full Gospel Church</div>
            <div class="trial-badge">15-Day Trial</div>
        </div>

        <div class="license-info" id="licenseInfo">
            <div class="left">
                <span class="icon">ğŸ”‘</span>
                <span class="text">ì²´í—˜íŒ ë¼ì´ì„ ìŠ¤</span>
            </div>
            <span class="days" id="remainingDays">ë¡œë”©ì¤‘...</span>
        </div>

        <div class="card">
            <h2 class="card-title">ğŸ“„ ì£¼ë³´ PDF ì—…ë¡œë“œ</h2>

            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“¤</div>
                <h3>ì—¬ì˜ë„ìˆœë³µìŒêµíšŒ ì£¼ë³´ PDFë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</h3>
                <p>í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ëŒì–´ë‹¤ ë†“ìœ¼ì„¸ìš”</p>
                <input type="file" class="file-input" id="fileInput" accept=".pdf">
                <div id="fileList"></div>
            </div>

            <div class="settings-section">
                <div class="settings-row">
                    <span class="settings-label">â›ª êµíšŒëª…</span>
                    <input type="text" class="settings-value fixed" id="churchName" value="ì—¬ì˜ë„ìˆœë³µìŒêµíšŒ" readonly>
                </div>
                <div class="settings-row">
                    <span class="settings-label">ğŸ“… ì£¼ë³´ ë‚ ì§œ</span>
                    <input type="date" class="settings-value" id="bulletinDate">
                </div>
                <div>
                    <span class="settings-label">ğŸ„ ì ˆê¸° í…Œë§ˆ</span>
                    <div class="theme-grid" id="themeGrid">
                        <div class="theme-option selected" data-theme="default" onclick="selectTheme('default')">
                            <div class="icon">ğŸ“–</div>
                            <div class="name">ì¼ë°˜</div>
                        </div>
                        <div class="theme-option" data-theme="advent" onclick="selectTheme('advent')">
                            <div class="icon">ğŸ•¯ï¸</div>
                            <div class="name">ëŒ€ë¦¼ì ˆ</div>
                        </div>
                        <div class="theme-option" data-theme="christmas" onclick="selectTheme('christmas')">
                            <div class="icon">ğŸ„</div>
                            <div class="name">ì„±íƒ„ì ˆ</div>
                        </div>
                        <div class="theme-option" data-theme="lent" onclick="selectTheme('lent')">
                            <div class="icon">âœï¸</div>
                            <div class="name">ì‚¬ìˆœì ˆ</div>
                        </div>
                        <div class="theme-option" data-theme="easter" onclick="selectTheme('easter')">
                            <div class="icon">ğŸ£</div>
                            <div class="name">ë¶€í™œì ˆ</div>
                        </div>
                        <div class="theme-option" data-theme="pentecost" onclick="selectTheme('pentecost')">
                            <div class="icon">ğŸ”¥</div>
                            <div class="name">ì„±ë ¹ê°•ë¦¼</div>
                        </div>
                        <div class="theme-option" data-theme="harvest" onclick="selectTheme('harvest')">
                            <div class="icon">ğŸŒ¾</div>
                            <div class="name">ì¶”ìˆ˜ê°ì‚¬</div>
                        </div>
                    </div>
                </div>
            </div>

            <button class="convert-btn disabled" id="convertBtn" disabled>
                <span>PDFë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
            </button>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">ë³€í™˜ ì¤‘...</div>
                <div class="progress-timer">
                    <span class="elapsed">â±ï¸ ê²½ê³¼: <span id="elapsedTime">0:00</span></span>
                    <span class="remaining">ğŸ“ ì˜ˆìƒ ë‚¨ì€ ì‹œê°„: <span id="remainingTime">ì•½ 6ë¶„</span></span>
                </div>
            </div>

            <div class="error-container" id="errorContainer"></div>
        </div>

        <div class="card result-container" id="resultContainer">
            <div class="result-success">
                <h3>âœ… ë³€í™˜ ì™„ë£Œ!</h3>
                <div class="result-info" id="resultInfo"></div>
            </div>
            <div class="result-actions">
                <a href="#" class="btn-preview" id="previewBtn" target="_blank">ë¯¸ë¦¬ë³´ê¸°</a>
                <a href="#" class="btn-download" id="downloadBtn" download>HTML ë‹¤ìš´ë¡œë“œ</a>
                <button class="btn-verify" id="verifyBtn" style="background: linear-gradient(135deg, #3498DB, #2980B9); color: white;">ğŸ” ê²€ì¦í•˜ê¸°</button>
                <button class="btn-reset" id="resetBtn">ìƒˆë¡œ ë³€í™˜</button>
                <button class="btn-clear" id="clearCacheBtn">ğŸ—‘ï¸ ìºì‹œ ì‚­ì œ</button>
            </div>

            <!-- ê²€ì¦ ê²°ê³¼ ì„¹ì…˜ -->
            <div class="verify-result" id="verifyResult" style="display: none; margin-top: 20px; padding: 20px; background: #F0F8FF; border-radius: 12px; border: 2px solid #3498DB;">
                <h4 style="color: #2980B9; margin-bottom: 15px;">ğŸ” ê²€ì¦ ê²°ê³¼</h4>
                <div class="verify-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                    <div class="stat-box" style="text-align: center; padding: 15px; background: white; border-radius: 10px;">
                        <div class="stat-value" id="verifyAccuracy" style="font-size: 2em; font-weight: 700; color: #27AE60;">--%</div>
                        <div class="stat-label" style="color: #666; font-size: 0.9em;">ì •í™•ë„</div>
                    </div>
                    <div class="stat-box" style="text-align: center; padding: 15px; background: white; border-radius: 10px;">
                        <div class="stat-value" id="verifyErrors" style="font-size: 2em; font-weight: 700; color: #E74C3C;">--</div>
                        <div class="stat-label" style="color: #666; font-size: 0.9em;">ì˜¤ë¥˜</div>
                    </div>
                    <div class="stat-box" style="text-align: center; padding: 15px; background: white; border-radius: 10px;">
                        <div class="stat-value" id="verifyWarnings" style="font-size: 2em; font-weight: 700; color: #F39C12;">--</div>
                        <div class="stat-label" style="color: #666; font-size: 0.9em;">ê²½ê³ </div>
                    </div>
                </div>
                <div id="verifyDetails" style="max-height: 200px; overflow-y: auto; background: white; padding: 15px; border-radius: 10px; font-family: monospace; font-size: 0.85em;"></div>
                <div id="verifyCorrections" style="margin-top: 15px;"></div>
            </div>
        </div>

        <div class="cache-warning">
            <h3>âš ï¸ ë³€í™˜ ë¬¸ì œ ë°œìƒ ì‹œ</h3>
            <p>ì´ì „ PDF ë°ì´í„°ê°€ ë‚¨ì•„ìˆì–´ ì˜ëª»ëœ ê²°ê³¼ê°€ ë‚˜ì˜¬ ê²½ìš°, ìºì‹œë¥¼ ì™„ì „íˆ ì‚­ì œ í›„ ë‹¤ì‹œ ë³€í™˜í•˜ì„¸ìš”.</p>
            <div class="cache-buttons">
                <button id="fullClearBtn" style="background: #dc3545; color: white;">ğŸ—‘ï¸ ì „ì²´ ìºì‹œ ì‚­ì œ</button>
                <button id="hardRefreshBtn" style="background: #fd7e14; color: white;">ğŸ”„ ê°•ë ¥ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <p id="cacheStatus" style="margin-top: 10px; font-size: 0.85em;"></p>
        </div>
    </div>

    <script>
        // ìƒìˆ˜
        const CHURCH_NAME = 'ì—¬ì˜ë„ìˆœë³µìŒêµíšŒ';
        const CHURCH_ID = 'fgfc';

        // ìš”ì†Œ
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const convertBtn = document.getElementById('convertBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const elapsedTimeEl = document.getElementById('elapsedTime');
        const remainingTimeEl = document.getElementById('remainingTime');
        const resultContainer = document.getElementById('resultContainer');
        const errorContainer = document.getElementById('errorContainer');

        let selectedFile = null;
        let selectedTheme = 'default';
        let licenseKey = null;
        let timerInterval = null;
        let conversionStartTime = null;
        const ESTIMATED_TOTAL_TIME = 180; // 3ë¶„ = 180ì´ˆ (1.6MB ê¸°ì¤€)

        // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
        function setTodayDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            document.getElementById('bulletinDate').value = `${year}-${month}-${day}`;
        }
        setTodayDate();

        // ë¼ì´ì„ ìŠ¤ ì´ˆê¸°í™”
        async function initLicense() {
            try {
                // ë¨¼ì € ìºì‹œ ì‚­ì œ (ë‹¤ë¥¸ êµíšŒ ë°ì´í„° ê²©ë¦¬)
                await fetch('/api/cache/clear', { method: 'POST' });

                const response = await fetch('/api/license/fgfc-trial', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    licenseKey = data.license.license_key;
                    document.getElementById('remainingDays').textContent = `${data.license.remaining_days}ì¼ ë‚¨ìŒ`;

                    if (data.license.remaining_days <= 3) {
                        document.getElementById('licenseInfo').style.borderColor = '#E74C3C';
                        document.getElementById('remainingDays').style.background = '#E74C3C';
                    }
                } else {
                    document.getElementById('remainingDays').textContent = 'ì˜¤ë¥˜';
                }
            } catch (e) {
                console.error('ë¼ì´ì„ ìŠ¤ ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
                document.getElementById('remainingDays').textContent = 'ì—°ê²° ì˜¤ë¥˜';
            }
        }
        initLicense();

        // íƒ€ì´ë¨¸ í•¨ìˆ˜
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${String(secs).padStart(2, '0')}`;
        }

        function startTimer() {
            conversionStartTime = Date.now();
            elapsedTimeEl.textContent = '0:00';
            remainingTimeEl.textContent = 'ì•½ 3ë¶„';

            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - conversionStartTime) / 1000);
                elapsedTimeEl.textContent = formatTime(elapsed);

                // íŒŒì¼ í¬ê¸° ê¸°ë°˜ ì˜ˆìƒ ì‹œê°„ (1.6MB = 360ì´ˆ ê¸°ì¤€)
                const fileSize = selectedFile ? selectedFile.size / (1024 * 1024) : 1.6;
                const estimatedTotal = Math.max(60, Math.round(ESTIMATED_TOTAL_TIME * (fileSize / 1.6)));
                const remaining = Math.max(0, estimatedTotal - elapsed);

                if (remaining > 60) {
                    remainingTimeEl.textContent = `ì•½ ${Math.ceil(remaining / 60)}ë¶„`;
                } else if (remaining > 0) {
                    remainingTimeEl.textContent = `ì•½ ${remaining}ì´ˆ`;
                } else {
                    remainingTimeEl.textContent = 'ê±°ì˜ ì™„ë£Œ...';
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // í…Œë§ˆ ì„ íƒ
        function selectTheme(theme) {
            selectedTheme = theme;
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.theme === theme);
            });
        }

        // íŒŒì¼ ì—…ë¡œë“œ
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });

        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', () => handleFile(fileInput.files[0]));

        function handleFile(file) {
            if (!file || !file.name.toLowerCase().endsWith('.pdf')) {
                showError('PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            selectedFile = file;
            renderFileList();
            updateConvertButton();
        }

        function renderFileList() {
            if (!selectedFile) {
                fileList.innerHTML = '';
                uploadArea.classList.remove('has-file');
                return;
            }

            uploadArea.classList.add('has-file');
            fileList.innerHTML = `
                <div class="file-info">
                    <span class="icon">ğŸ“„</span>
                    <div class="details">
                        <div class="name">${selectedFile.name}</div>
                        <div class="size">${formatFileSize(selectedFile.size)}</div>
                    </div>
                    <button class="remove" onclick="removeFile()">ì‚­ì œ</button>
                </div>
            `;
        }

        function removeFile() {
            selectedFile = null;
            renderFileList();
            updateConvertButton();
            fileInput.value = '';
        }

        function updateConvertButton() {
            if (selectedFile) {
                convertBtn.disabled = false;
                convertBtn.className = 'convert-btn ready';
                convertBtn.innerHTML = '<span>ğŸ¤– AI ë³€í™˜ ì‹œì‘</span>';
            } else {
                convertBtn.disabled = true;
                convertBtn.className = 'convert-btn disabled';
                convertBtn.innerHTML = '<span>PDFë¥¼ ì„ íƒí•˜ì„¸ìš”</span>';
            }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function showError(message) {
            errorContainer.textContent = message;
            errorContainer.classList.add('show');
            setTimeout(() => errorContainer.classList.remove('show'), 5000);
        }

        function getThemeName(theme) {
            const names = {
                'default': 'ì¼ë°˜', 'advent': 'ëŒ€ë¦¼ì ˆ', 'christmas': 'ì„±íƒ„ì ˆ',
                'lent': 'ì‚¬ìˆœì ˆ', 'easter': 'ë¶€í™œì ˆ', 'pentecost': 'ì„±ë ¹ê°•ë¦¼ì ˆ', 'harvest': 'ì¶”ìˆ˜ê°ì‚¬ì ˆ'
            };
            return names[theme] || theme;
        }

        // ë³€í™˜ ì‹¤í–‰
        convertBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            const bulletinDate = document.getElementById('bulletinDate').value;
            if (!bulletinDate) {
                showError('ì£¼ë³´ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            errorContainer.classList.remove('show');
            resultContainer.classList.remove('show');

            convertBtn.disabled = true;
            convertBtn.className = 'convert-btn loading';
            convertBtn.innerHTML = '<span>ğŸ”„ ë³€í™˜ ì¤‘...</span>';

            progressContainer.classList.add('show');
            progressFill.style.width = '5%';
            progressText.textContent = 'ğŸ“¤ PDF ì—…ë¡œë“œ ì¤‘...';

            // íƒ€ì´ë¨¸ ì‹œì‘
            startTimer();

            // ì§„í–‰ ìƒí™© ë©”ì‹œì§€ (ì‹¤ì œ ì„œë²„ ì‘ì—… ê¸°ì¤€ ì•½ 3ë¶„)
            const progressSteps = [
                { percent: 5, text: 'ğŸ“„ PDF ì—…ë¡œë“œ ì™„ë£Œ, ë¶„ì„ ì¤€ë¹„ ì¤‘...', delay: 1000 },
                { percent: 10, text: 'ğŸ¤– í˜ì´ì§€ 1/6 AI ë¶„ì„ ì¤‘...', delay: 3000 },
                { percent: 18, text: 'âœ… í˜ì´ì§€ 1/6 ì¶”ì¶œ ì„±ê³µ', delay: 10000 },
                { percent: 22, text: 'ğŸ¤– í˜ì´ì§€ 2/6 AI ë¶„ì„ ì¤‘...', delay: 12000 },
                { percent: 30, text: 'âœ… í˜ì´ì§€ 2/6 ì¶”ì¶œ ì„±ê³µ', delay: 25000 },
                { percent: 35, text: 'ğŸ¤– í˜ì´ì§€ 3/6 AI ë¶„ì„ ì¤‘... (ì˜ˆë°°ìˆœì„œ)', delay: 27000 },
                { percent: 45, text: 'âœ… í˜ì´ì§€ 3/6 ì¶”ì¶œ ì„±ê³µ', delay: 50000 },
                { percent: 50, text: 'ğŸ¤– í˜ì´ì§€ 4/6 AI ë¶„ì„ ì¤‘... (ì˜¤ëŠ˜ì˜ ë§ì”€)', delay: 52000 },
                { percent: 60, text: 'âœ… í˜ì´ì§€ 4/6 ì¶”ì¶œ ì„±ê³µ', delay: 85000 },
                { percent: 65, text: 'ğŸ¤– í˜ì´ì§€ 5/6 AI ë¶„ì„ ì¤‘... (êµíšŒì†Œì‹)', delay: 87000 },
                { percent: 73, text: 'âœ… í˜ì´ì§€ 5/6 ì¶”ì¶œ ì„±ê³µ', delay: 112000 },
                { percent: 78, text: 'ğŸ¤– í˜ì´ì§€ 6/6 AI ë¶„ì„ ì¤‘... (ì˜¤ëŠ˜ì˜ ì–‘ì‹)', delay: 114000 },
                { percent: 83, text: 'âœ… í˜ì´ì§€ 6/6 ì¶”ì¶œ ì„±ê³µ', delay: 132000 },
                { percent: 88, text: 'ğŸŒ ë‹¤êµ­ì–´ ë²ˆì—­ ì¤‘ (8ê°œêµ­ì–´)...', delay: 135000 },
                { percent: 95, text: 'ğŸ“ HTML ìƒì„± ë° íŒŒì¼ ì €ì¥ ì¤‘...', delay: 165000 },
                { percent: 98, text: 'âœ… ê±°ì˜ ì™„ë£Œ...', delay: 175000 }
            ];

            // ì§„í–‰ ìƒí™© íƒ€ì´ë¨¸ ì„¤ì •
            const timers = progressSteps.map(step =>
                setTimeout(() => {
                    progressFill.style.width = step.percent + '%';
                    progressText.textContent = step.text;
                }, step.delay)
            );

            try {
                const formData = new FormData();
                formData.append('file', selectedFile);
                formData.append('church_name', CHURCH_NAME);
                formData.append('bulletin_date', bulletinDate);
                formData.append('theme', selectedTheme);
                if (licenseKey) {
                    formData.append('license_key', licenseKey);
                }

                const startTime = Date.now();
                const response = await fetch('/api/church-convert-ai', {
                    method: 'POST',
                    body: formData
                });

                // íƒ€ì´ë¨¸ ì •ë¦¬
                timers.forEach(t => clearTimeout(t));
                stopTimer();
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                const elapsedMinSec = formatTime(Math.floor((Date.now() - startTime) / 1000));

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'ë³€í™˜ ì‹¤íŒ¨');
                }

                const result = await response.json();

                progressFill.style.width = '100%';
                progressText.textContent = `âœ… ì™„ë£Œ!`;
                elapsedTimeEl.textContent = elapsedMinSec;
                remainingTimeEl.textContent = 'ì™„ë£Œë¨';

                setTimeout(() => {
                    progressContainer.classList.remove('show');
                    showResult(result);
                }, 1500);

            } catch (error) {
                // íƒ€ì´ë¨¸ ì •ë¦¬
                timers.forEach(t => clearTimeout(t));
                stopTimer();
                progressContainer.classList.remove('show');
                showError(error.message);
                updateConvertButton();
            }
        });

        function showResult(data) {
            resultContainer.classList.add('show');

            const resultInfo = document.getElementById('resultInfo');
            resultInfo.innerHTML = `
                <div class="result-item">
                    <div class="label">êµíšŒ</div>
                    <div class="value">${data.church_name || CHURCH_NAME}</div>
                </div>
                <div class="result-item">
                    <div class="label">ë‚ ì§œ</div>
                    <div class="value">${data.bulletin_date || ''}</div>
                </div>
                <div class="result-item">
                    <div class="label">í…Œë§ˆ</div>
                    <div class="value">${getThemeName(data.theme)}</div>
                </div>
                <div class="result-item">
                    <div class="label">ë³€í™˜ë°©ì‹</div>
                    <div class="value">ğŸ¤– AI Powered</div>
                </div>
            `;

            document.getElementById('previewBtn').href = data.url;
            document.getElementById('downloadBtn').href = data.url;
            document.getElementById('downloadBtn').download = data.filename;

            convertBtn.innerHTML = '<span>âœ… ì™„ë£Œ!</span>';
            convertBtn.className = 'convert-btn ready';
        }

        // ë¦¬ì…‹
        document.getElementById('resetBtn').addEventListener('click', () => {
            selectedFile = null;
            renderFileList();
            updateConvertButton();
            resultContainer.classList.remove('show');
            document.getElementById('verifyResult').style.display = 'none';
            fileInput.value = '';
        });

        // ê²€ì¦ ë²„íŠ¼ í•¸ë“¤ëŸ¬
        let lastConversionData = null;
        document.getElementById('verifyBtn').addEventListener('click', async () => {
            const verifyBtn = document.getElementById('verifyBtn');
            const verifyResult = document.getElementById('verifyResult');

            verifyBtn.disabled = true;
            verifyBtn.innerHTML = 'ğŸ”„ ê²€ì¦ ì¤‘...';

            try {
                // HTML ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
                const htmlPath = document.getElementById('previewBtn').href;
                const urlParts = htmlPath.split('/outputs/');
                const relativePath = urlParts.length > 1 ? urlParts[1] : '';

                // ê²€ì¦ API í˜¸ì¶œ
                const formData = new FormData();
                formData.append('html_path', relativePath);

                const response = await fetch('/api/fgfc/verify', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    // ê²°ê³¼ í‘œì‹œ
                    verifyResult.style.display = 'block';

                    // ì •í™•ë„
                    const accuracy = data.overall_accuracy || 0;
                    document.getElementById('verifyAccuracy').textContent = accuracy.toFixed(1) + '%';
                    document.getElementById('verifyAccuracy').style.color =
                        accuracy >= 95 ? '#27AE60' : accuracy >= 80 ? '#F39C12' : '#E74C3C';

                    // ì˜¤ë¥˜/ê²½ê³  ìˆ˜
                    const ocr = data.ocr_validation || {};
                    document.getElementById('verifyErrors').textContent = (ocr.errors || []).length;
                    document.getElementById('verifyWarnings').textContent = (ocr.warnings || []).length;

                    // ìƒì„¸ ë‚´ìš©
                    let detailsHtml = '';
                    if (ocr.errors && ocr.errors.length > 0) {
                        detailsHtml += '<div style="color: #E74C3C; margin-bottom: 10px;"><strong>âŒ ì˜¤ë¥˜:</strong></div>';
                        ocr.errors.forEach(err => {
                            detailsHtml += `<div style="padding: 5px 0; border-bottom: 1px solid #eee;">
                                [${err.field}] ${err.actual} â†’ ì˜ˆìƒ: ${err.expected}
                                ${err.suggestion ? '<br><span style="color: #3498DB;">ğŸ’¡ ' + err.suggestion + '</span>' : ''}
                            </div>`;
                        });
                    }

                    if (ocr.warnings && ocr.warnings.length > 0) {
                        detailsHtml += '<div style="color: #F39C12; margin-top: 10px;"><strong>âš ï¸ ê²½ê³ :</strong></div>';
                        ocr.warnings.forEach(warn => {
                            detailsHtml += `<div style="padding: 5px 0;">[${warn.field}] ${warn.actual}</div>`;
                        });
                    }

                    if (!detailsHtml) {
                        detailsHtml = '<div style="color: #27AE60; text-align: center; padding: 20px;">âœ… ëª¨ë“  ê²€ì¦ì„ í†µê³¼í–ˆìŠµë‹ˆë‹¤!</div>';
                    }

                    document.getElementById('verifyDetails').innerHTML = detailsHtml;

                    // ìë™ êµì • ì œì•ˆ
                    if (data.auto_corrections && data.auto_corrections.length > 0) {
                        let correctionsHtml = '<div style="background: #FFFBEB; padding: 15px; border-radius: 10px; border: 1px solid #F39C12;">';
                        correctionsHtml += '<strong style="color: #B7791F;">âœ¨ ìë™ êµì • ì œì•ˆ:</strong><ul style="margin: 10px 0 0 20px;">';
                        data.auto_corrections.forEach(c => {
                            correctionsHtml += `<li>${c}</li>`;
                        });
                        correctionsHtml += '</ul></div>';
                        document.getElementById('verifyCorrections').innerHTML = correctionsHtml;
                    } else {
                        document.getElementById('verifyCorrections').innerHTML = '';
                    }

                } else {
                    verifyResult.style.display = 'block';
                    document.getElementById('verifyDetails').innerHTML =
                        `<div style="color: #E74C3C;">âŒ ê²€ì¦ ì‹¤íŒ¨: ${data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</div>`;
                }

            } catch (e) {
                console.error('ê²€ì¦ ì˜¤ë¥˜:', e);
                verifyResult.style.display = 'block';
                document.getElementById('verifyDetails').innerHTML =
                    `<div style="color: #E74C3C;">âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${e.message}</div>`;
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.innerHTML = 'ğŸ” ê²€ì¦í•˜ê¸°';
            }
        });

        // ìºì‹œ ì‚­ì œ
        document.getElementById('clearCacheBtn').addEventListener('click', clearCache);
        document.getElementById('fullClearBtn').addEventListener('click', clearCache);

        async function clearCache() {
            const statusEl = document.getElementById('cacheStatus');
            statusEl.textContent = 'ì‚­ì œ ì¤‘...';

            try {
                const response = await fetch('/api/cache/clear', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    localStorage.clear();
                    sessionStorage.clear();
                    statusEl.textContent = 'âœ… ìºì‹œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.';
                    statusEl.style.color = '#27AE60';
                    setTimeout(() => location.reload(true), 1000);
                } else {
                    statusEl.textContent = 'âŒ ì˜¤ë¥˜: ' + result.error;
                    statusEl.style.color = '#dc3545';
                }
            } catch (e) {
                statusEl.textContent = 'âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜';
                statusEl.style.color = '#dc3545';
            }
        }

        // ê°•ë ¥ ìƒˆë¡œê³ ì¹¨
        document.getElementById('hardRefreshBtn').addEventListener('click', () => {
            localStorage.clear();
            sessionStorage.clear();
            if ('caches' in window) {
                caches.keys().then(names => names.forEach(name => caches.delete(name)));
            }
            location.href = location.href.split('?')[0] + '?nocache=' + Date.now();
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ íƒ€ì„ìŠ¤íƒ¬í”„
        document.getElementById('cacheStatus').textContent = `ë§ˆì§€ë§‰ ë¡œë“œ: ${new Date().toLocaleString('ko-KR')}`;
    </script>
</body>
</html>
